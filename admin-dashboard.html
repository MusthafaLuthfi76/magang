<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Rekap Nilai ‚Äî Dinas Koperasi UKM</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #f0f2f7;
            --surface: #ffffff;
            --surface2: #f8f9fc;
            --border: #e4e7ef;
            --text: #0f1729;
            --text2: #5a6483;
            --text3: #9aa3bf;
            --accent: #2563eb;
            --sidebar-w: 248px;
            --header-h: 68px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 15px; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); display: flex; min-height: 100vh; }

        /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
        .toast-container { position: fixed; top: 16px; right: 16px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
        .toast { background: var(--surface); padding: 13px 16px; border-radius: 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); min-width: 280px; animation: toastIn .3s cubic-bezier(.34,1.56,.64,1); display: flex; align-items: center; gap: 10px; font-size: 13px; font-weight: 500; }
        .toast.success { border-left: 3px solid #10b981; }
        .toast.error   { border-left: 3px solid #ef4444; }
        @keyframes toastIn { from { transform: translateX(120px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* ‚îÄ‚îÄ OVERLAY ‚îÄ‚îÄ */
        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 998; backdrop-filter: blur(2px); }
        .sidebar-overlay.active { display: block; }

        /* ‚îÄ‚îÄ MOBILE TOGGLE ‚îÄ‚îÄ */
        .mobile-toggle { display: none; position: fixed; top: 16px; left: 16px; z-index: 1001; width: 40px; height: 40px; border-radius: 10px; background: var(--surface); border: 1px solid var(--border); cursor: pointer; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .mobile-toggle svg { width: 18px; height: 18px; stroke: var(--text); fill: none; stroke-width: 2; }

        /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
        .sidebar {
            width: var(--sidebar-w); background: var(--surface); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; position: fixed; height: 100vh; left: 0; top: 0; z-index: 999;
            transition: transform .3s cubic-bezier(.4,0,.2,1);
        }
        .sidebar-head { padding: 20px 16px 16px; border-bottom: 1px solid var(--border); }
        .sidebar-logo { display: flex; align-items: center; gap: 10px; }
        .logo-mark { width: 38px; height: 38px; border-radius: 10px; overflow: hidden; flex-shrink: 0; }
        .logo-mark img { width: 100%; height: 100%; object-fit: cover; }
        .logo-text .t1 { font-size: 14px; font-weight: 700; color: var(--text); }
        .logo-text .t2 { font-size: 11px; color: var(--text3); margin-top: 1px; }
        .sidebar-nav { flex: 1; padding: 12px 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 2px; }
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; font-size: 13.5px; font-weight: 500; color: var(--text2); text-decoration: none; transition: all .15s; position: relative; }
        .nav-item:hover { background: var(--bg); color: var(--text); }
        .nav-item.active { background: #eff6ff; color: #1d4ed8; font-weight: 600; }
        .nav-item.active::before { content: ''; position: absolute; left: 0; top: 6px; bottom: 6px; width: 3px; background: #2563eb; border-radius: 0 3px 3px 0; }
        .nav-icon { width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 1.8; flex-shrink: 0; }
        .sidebar-foot { padding: 12px 10px; border-top: 1px solid var(--border); }
        .user-chip { padding: 10px 12px; border-radius: 8px; background: var(--bg); margin-bottom: 8px; }
        .user-chip .u-name { font-size: 13px; font-weight: 600; color: var(--text); }
        .user-chip .u-email { font-size: 11px; color: var(--text3); margin-top: 2px; }
        .logout-btn { width: 100%; padding: 9px; border-radius: 8px; border: 1px solid var(--border); background: var(--surface); font-family: inherit; font-size: 13px; font-weight: 500; color: var(--text2); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all .15s; }
        .logout-btn:hover { background: #fef2f2; color: #dc2626; border-color: #fca5a5; }

        /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
        .main { margin-left: var(--sidebar-w); display: flex; flex-direction: column; min-height: 100vh; }

        /* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
        .topbar { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 28px; height: var(--header-h); display: flex; align-items: center; justify-content: space-between; gap: 16px; position: sticky; top: 0; z-index: 100; }
        .topbar-left h1 { font-size: 18px; font-weight: 700; color: var(--text); }
        .topbar-left p { font-size: 12px; color: var(--text3); margin-top: 2px; }
        .topbar-right { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        .month-pill { display: flex; align-items: center; gap: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 7px 12px; }
        .month-pill label { font-size: 12px; color: var(--text3); font-weight: 500; white-space: nowrap; }
        .month-pill select { background: none; border: none; font-family: inherit; font-size: 13px; font-weight: 700; color: var(--text); cursor: pointer; outline: none; }
        .btn { padding: 8px 14px; border-radius: 8px; border: 1px solid var(--border); font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit; background: var(--surface); color: var(--text); display: inline-flex; align-items: center; gap: 6px; transition: all .2s; white-space: nowrap; }
        .btn:hover { background: var(--bg); }
        .btn-primary { background: #1d4ed8; color: white; border-color: #1d4ed8; }
        .btn-primary:hover { background: #1e40af; }

        /* ‚îÄ‚îÄ PAGE BODY ‚îÄ‚îÄ */
        .page { padding: 22px 28px; }

        /* ‚îÄ‚îÄ BANNER ‚îÄ‚îÄ */
        .banner { background: linear-gradient(135deg, #0f1729 0%, #1e3a6e 60%, #1e40af 100%); border-radius: 12px; padding: 18px 22px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; }
        .banner h2 { color: white; font-size: 15px; font-weight: 700; }
        .banner p { color: #94a3b8; font-size: 11.5px; margin-top: 3px; }
        .banner-pills { display: flex; flex-wrap: wrap; gap: 6px; }
        .bpill { display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15); border-radius: 20px; padding: 4px 10px; font-size: 11px; font-weight: 600; color: #e2e8f0; }
        .bdot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }

        /* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 20px; }
        .scard { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 18px; position: relative; overflow: hidden; }
        .scard::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: var(--scolor, #e5e7eb); }
        .scard-label { font-size: 12px; font-weight: 500; color: var(--text3); margin-bottom: 8px; }
        .scard-val { font-size: 28px; font-weight: 800; color: var(--text); line-height: 1; }
        .scard-sub { font-size: 11.5px; color: var(--text3); margin-top: 5px; }
        .sk { background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: shim 1.3s infinite; border-radius: 6px; height: 64px; }
        @keyframes shim { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* ‚îÄ‚îÄ CHART TABS ‚îÄ‚îÄ */
        .ctabs { display: flex; gap: 3px; background: var(--bg); border-radius: 10px; padding: 3px; margin-bottom: 18px; overflow-x: auto; }
        .ctab { flex: 1; min-width: 110px; padding: 8px 12px; border-radius: 7px; border: none; background: none; font-family: inherit; font-size: 12.5px; font-weight: 600; color: var(--text3); cursor: pointer; transition: all .15s; white-space: nowrap; text-align: center; }
        .ctab.active { background: var(--surface); color: var(--text); box-shadow: 0 1px 4px rgba(0,0,0,0.1); }

        /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 18px; }
        .card-head { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; }
        .card-title { font-size: 14.5px; font-weight: 700; color: var(--text); }
        .card-note { font-size: 11.5px; color: var(--text3); }
        .card-body { padding: 18px; }

        /* ‚îÄ‚îÄ GRIDS ‚îÄ‚îÄ */
        .g2 { display: grid; grid-template-columns: 3fr 2fr; gap: 16px; margin-bottom: 18px; }
        .g3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-bottom: 18px; }

        /* ‚îÄ‚îÄ CHART WRAPS ‚îÄ‚îÄ */
        .cw { position: relative; }
        .cw.h380 { height: 380px; }
        .cw.h300 { height: 300px; }
        .cw.h230 { height: 230px; }

        /* ‚îÄ‚îÄ CAT BUTTONS ‚îÄ‚îÄ */
        .catrow { display: flex; flex-wrap: wrap; gap: 7px; margin-bottom: 14px; }
        .catbtn { padding: 5px 13px; border-radius: 20px; border: none; font-family: inherit; font-size: 12.5px; font-weight: 600; cursor: pointer; background: var(--bg); color: var(--text3); transition: all .15s; }

        /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
        .tbl-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table.rt { width: 100%; border-collapse: collapse; font-size: 12.5px; white-space: nowrap; }
        table.rt thead tr { background: #0f1729; }
        table.rt th { padding: 11px 13px; text-align: left; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .04em; color: #94a3b8; }
        table.rt th.c { text-align: center; }
        table.rt td { padding: 11px 13px; border-bottom: 1px solid var(--bg); vertical-align: middle; }
        table.rt tbody tr:last-child td { border-bottom: none; }
        table.rt tbody tr:hover { background: var(--bg); }

        .chip { display: inline-flex; align-items: center; justify-content: center; padding: 3px 9px; border-radius: 20px; font-size: 11.5px; font-weight: 700; min-width: 42px; }
        .chip-none  { background: var(--bg); color: var(--text3); }
        .chip-great { background: #d1fae5; color: #065f46; }
        .chip-good  { background: #dbeafe; color: #1e40af; }
        .chip-fair  { background: #fef3c7; color: #92400e; }
        .chip-poor  { background: #fee2e2; color: #991b1b; }

        .tchip { display: inline-flex; align-items: center; justify-content: center; padding: 5px 13px; border-radius: 8px; font-weight: 800; font-size: 13px; }
        .tgreat { background: #d1fae5; color: #065f46; }
        .tgood  { background: #dbeafe; color: #1e40af; }
        .tfair  { background: #fef3c7; color: #92400e; }
        .tpoor  { background: #fee2e2; color: #991b1b; }
        .tnone  { background: var(--bg); color: var(--text3); }

        .rank { display: inline-flex; align-items: center; justify-content: center; width: 22px; height: 22px; border-radius: 6px; background: var(--bg); color: var(--text3); font-size: 11px; font-weight: 700; margin-right: 4px; }
        .prog-row { display: flex; align-items: center; gap: 7px; min-width: 110px; }
        .prog-bar { flex: 1; height: 5px; background: var(--bg); border-radius: 3px; overflow: hidden; }
        .prog-fill { height: 100%; border-radius: 3px; }
        .prog-lbl { font-size: 11px; color: var(--text3); font-weight: 600; width: 34px; text-align: right; }

        .tbl-legend { display: flex; flex-wrap: wrap; gap: 10px; padding: 11px 18px; border-top: 1px solid var(--border); background: var(--bg); font-size: 11px; color: var(--text3); border-radius: 0 0 10px 10px; }
        .leg { display: flex; align-items: center; gap: 5px; }
        .leg-dot { width: 7px; height: 7px; border-radius: 50%; }

        .empty { text-align: center; padding: 48px 20px; color: var(--text3); font-size: 13px; }
        .section-head { display: flex; align-items: baseline; justify-content: space-between; margin-bottom: 14px; flex-wrap: wrap; gap: 6px; }
        .sec-title { font-size: 15px; font-weight: 700; color: var(--text); }
        .sec-note { font-size: 12px; color: var(--text3); }

        /* ‚îÄ‚îÄ MOBILE CARDS (hidden on desktop) ‚îÄ‚îÄ */
        .mobile-rekap { display: none; }
        .mcard { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 14px 16px; margin-bottom: 12px; }
        .mcard-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .mcard-name { font-size: 13.5px; font-weight: 700; color: var(--text); }
        .mcard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .mitem { background: var(--bg); border-radius: 6px; padding: 8px 10px; }
        .mitem-label { font-size: 10.5px; color: var(--text3); font-weight: 500; margin-bottom: 3px; }
        .mitem-val { font-size: 14px; font-weight: 700; color: var(--text); }
        .mcard-prog { margin-top: 10px; }
        .mprog-bar { height: 6px; background: var(--bg); border-radius: 3px; overflow: hidden; margin-top: 6px; }
        .mprog-fill { height: 100%; border-radius: 3px; }
        .mprog-label { display: flex; justify-content: space-between; font-size: 11px; color: var(--text3); font-weight: 600; }

        /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
        @media (max-width: 1200px) { .g2 { grid-template-columns: 1fr; } .g3 { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 1023px) {
            .mobile-toggle { display: flex; }
            .sidebar { transform: translateX(-100%); box-shadow: none; }
            .sidebar.open { transform: translateX(0); box-shadow: 8px 0 32px rgba(0,0,0,0.15); }
            .main { margin-left: 0; }
            .topbar { padding: 0 16px 0 64px; }
            .topbar-left h1 { font-size: 16px; }
            .page { padding: 16px; }
            .stats-row { grid-template-columns: 1fr 1fr; gap: 10px; }
            .banner-pills { display: none; }
            .ctabs { }
            .ctab { min-width: 90px; font-size: 12px; padding: 7px 10px; }
            .g3 { grid-template-columns: 1fr; }
        }
        @media (max-width: 640px) {
            .stats-row { grid-template-columns: 1fr 1fr; gap: 10px; }
            .scard-val { font-size: 24px; }
            .topbar-right .month-pill label { display: none; }
            .tbl-wrap { display: none; }
            .mobile-rekap { display: block; }
            .tbl-legend { display: none; }
            .g2 { grid-template-columns: 1fr; }
            .banner h2 { font-size: 13px; }
            .banner p { font-size: 11px; }
        }
        @media (max-width: 420px) {
            .stats-row { grid-template-columns: 1fr 1fr; }
            .topbar-right .btn span { display: none; }
        }
    </style>
</head>
<body>

<div class="toast-container" id="toastBox"></div>

<!-- Mobile toggle -->
<button class="mobile-toggle" id="mToggle" onclick="toggleSidebar()">
    <svg viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
</button>
<div class="sidebar-overlay" id="sOverlay" onclick="toggleSidebar()"></div>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-head">
        <div class="sidebar-logo">
            <div class="logo-mark">
                <img src="https://yt3.googleusercontent.com/ytc/AIdro_lAD91TqpEoBLA60qxJfjXPWjPJG1qCHBRz8ZomYP_tkA=s900-c-k-c0x00ffffff-no-rj" alt="Logo">
            </div>
            <div class="logo-text">
                <div class="t1">Admin Panel</div>
                <div class="t2">Dinas Koperasi UKM</div>
            </div>
        </div>
    </div>
    <nav class="sidebar-nav">
        <a href="admin-dashboard.html" class="nav-item active">
            <svg class="nav-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>Dashboard
        </a>
        <a href="admin-requests.html" class="nav-item">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M14 3H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><path d="M14 3v6h6"/></svg>Kendaraan Dinas
        </a>
        <a href="admin-voucher-bbm.html" class="nav-item">
            <svg class="nav-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>Voucher BBM
        </a>
        <a href="admin-ruang-rapat.html" class="nav-item">
            <svg class="nav-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Ruang Rapat
        </a>
        <a href="admin-kearsipan.html" class="nav-item">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>Kearsipan Internal
        </a>
        <a href="admin-spj-keuangan.html" class="nav-item">
            <svg class="nav-icon" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>Penilaian SPJ Keuangan
        </a>
        <a href="admin-spj-pengumpulan.html" class="nav-item">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Pengumpulan SPJ
        </a>
        <a href="admin-pengajuan-dana.html" class="nav-item">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>Pengajuan Dana
        </a>
        <a href="admin-penilaian-monev.html" class="nav-item">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>Penilaian Monev
        </a>
    </nav>
    <div class="sidebar-foot">
        <div class="user-chip">
            <div class="u-name" id="adminName">Administrator</div>
            <div class="u-email" id="adminEmail">admin@dinas.gov.id</div>
        </div>
        <button onclick="logout()" class="logout-btn">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            Keluar
        </button>
    </div>
</aside>

<!-- Main -->
<div class="main">
    <header class="topbar">
        <div class="topbar-left">
            <h1>Dashboard Rekapitulasi Nilai</h1>
            <p id="hdDate">‚Äî</p>
        </div>
        <div class="topbar-right">
            <div class="month-pill">
                <label>Bulan:</label>
                <select id="bulanSel" onchange="onBulanChange()">
                    <option value="JANUARI">Januari</option><option value="FEBRUARI">Februari</option>
                    <option value="MARET">Maret</option><option value="APRIL">April</option>
                    <option value="MEI">Mei</option><option value="JUNI">Juni</option>
                    <option value="JULI">Juli</option><option value="AGUSTUS">Agustus</option>
                    <option value="SEPTEMBER">September</option><option value="OKTOBER">Oktober</option>
                    <option value="NOVEMBER">November</option><option value="DESEMBER">Desember</option>
                </select>
            </div>
            <button class="btn btn-primary" id="btnRef" onclick="loadAll()">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M23 4v6h-6"/><path d="M1 20v-6h6"/>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                </svg>
                <span>Refresh</span>
            </button>
        </div>
    </header>

    <div class="page">

        <!-- Banner -->
        <div class="banner">
            <div>
                <h2>Sistem Penilaian Kinerja ‚Äî Total Maksimal 100 Poin</h2>
                <p>Monev sekarang termasuk dalam total penilaian (BBM + Kendaraan + Ruang Rapat + Kearsipan + SPJ + Monev)</p>
            </div>
            <div class="banner-pills">
                <div class="bpill"><div class="bdot" style="background:#0ea5e9"></div>BBM /5</div>
                <div class="bpill"><div class="bdot" style="background:#f59e0b"></div>Kendaraan /10</div>
                <div class="bpill"><div class="bdot" style="background:#8b5cf6"></div>Ruang Rapat /5</div>
                <div class="bpill"><div class="bdot" style="background:#22c55e"></div>Kearsipan /5</div>
                <div class="bpill"><div class="bdot" style="background:#10b981"></div>SPJ /35</div>
                <div class="bpill"><div class="bdot" style="background:#ec4899"></div>Monev /40</div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-row" id="statsRow">
            <div class="scard"><div class="sk"></div></div>
            <div class="scard"><div class="sk"></div></div>
            <div class="scard"><div class="sk"></div></div>
            <div class="scard"><div class="sk"></div></div>
        </div>

        <!-- Section: Charts -->
        <div class="section-head">
            <span class="sec-title">Grafik Perbandingan Nilai</span>
            <span class="sec-note" id="secNote">‚Äî</span>
        </div>

        <div class="ctabs">
            <button class="ctab active" onclick="goTab('total',this)">üìä Total Divisi</button>
            <button class="ctab" onclick="goTab('trend',this)">üìà Tren Bulanan</button>
            <button class="ctab" onclick="goTab('cat',this)">üîç Per Kategori</button>
            <button class="ctab" onclick="goTab('profil',this)">üéØ Profil Divisi</button>
        </div>

        <!-- Panel: Total -->
        <div id="pTotal" data-active="1">
            <div class="g2">
                <div class="card">
                    <div class="card-head"><span class="card-title">Total Nilai per Divisi (Stacked /100)</span><span class="card-note" id="stkNote">‚Äî</span></div>
                    <div class="card-body"><div class="cw h380"><canvas id="cStacked"></canvas></div></div>
                </div>
                <div class="card">
                    <div class="card-head"><span class="card-title">Distribusi Modul (Radar)</span><span class="card-note">Rata-rata %</span></div>
                    <div class="card-body"><div class="cw h380"><canvas id="cRadar"></canvas></div></div>
                </div>
            </div>
        </div>

        <!-- Panel: Tren -->
        <div id="pTrend" style="display:none">
            <div class="card">
                <div class="card-head"><span class="card-title">Tren Total Nilai Lintas Bulan</span><span class="card-note">per Divisi, nilai /100</span></div>
                <div class="card-body"><div class="cw h380"><canvas id="cTrend"></canvas></div></div>
            </div>
            <div class="section-head"><span class="sec-title">Detail Modul per Divisi</span><span class="sec-note">Stacked per bulan</span></div>
            <div class="g3" id="trendSmall"></div>
        </div>

        <!-- Panel: Per Kategori -->
        <div id="pCat" style="display:none">
            <div class="section-head" style="margin-bottom:10px"><span class="sec-title">Pilih Kategori:</span></div>
            <div class="catrow" id="catRow"></div>
            <div class="card">
                <div class="card-head"><span class="card-title" id="catT1">‚Äî</span><span class="card-note" id="catN1">‚Äî</span></div>
                <div class="card-body"><div class="cw h380"><canvas id="cCat1"></canvas></div></div>
            </div>
            <div class="card">
                <div class="card-head"><span class="card-title" id="catT2">‚Äî</span><span class="card-note">Lintas bulan tiap divisi</span></div>
                <div class="card-body"><div class="cw h300"><canvas id="cCat2"></canvas></div></div>
            </div>
        </div>

        <!-- Panel: Profil -->
        <div id="pProfil" style="display:none">
            <div class="g3" id="radarGrid"></div>
        </div>

        <!-- Rekap Table -->
        <div class="section-head">
            <span class="sec-title">Rekap Nilai Lengkap per Divisi</span>
            <span class="sec-note">Diurutkan total tertinggi</span>
        </div>

        <div class="card" style="margin-bottom:32px">
            <!-- Desktop Table -->
            <div class="tbl-wrap">
                <table class="rt">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Divisi / Unit</th>
                            <th class="c"><span style="color:#0ea5e9">‚óè</span> BBM <small style="opacity:.6">/5</small></th>
                            <th class="c"><span style="color:#f59e0b">‚óè</span> Kendaraan <small style="opacity:.6">/10</small></th>
                            <th class="c"><span style="color:#8b5cf6">‚óè</span> Ruang Rapat <small style="opacity:.6">/5</small></th>
                            <th class="c"><span style="color:#22c55e">‚óè</span> Kearsipan <small style="opacity:.6">/5</small></th>
                            <th class="c"><span style="color:#10b981">‚óè</span> SPJ Keuangan <small style="opacity:.6">/35</small></th>
                            <th class="c"><span style="color:#ec4899">‚óè</span> Monev <small style="opacity:.6">/40</small></th>
                            <th class="c" style="background:#1a2942">Total <small style="opacity:.6">/100</small></th>
                            <th class="c">Progress</th>
                        </tr>
                    </thead>
                    <tbody id="rekapTbody"><tr><td colspan="10" class="empty">‚è≥ Memuat data...</td></tr></tbody>
                </table>
            </div>
            <!-- Mobile Cards -->
            <div class="mobile-rekap" id="mobileRekap"></div>
            <div class="tbl-legend">
                <div class="leg"><div class="leg-dot" style="background:#d1fae5"></div>Sangat Baik ‚â•80%</div>
                <div class="leg"><div class="leg-dot" style="background:#dbeafe"></div>Baik ‚â•60%</div>
                <div class="leg"><div class="leg-dot" style="background:#fef3c7"></div>Cukup ‚â•40%</div>
                <div class="leg"><div class="leg-dot" style="background:#fee2e2"></div>Kurang &lt;40%</div>
            </div>
        </div>

    </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const API_OP  = 'https://script.google.com/macros/s/AKfycbyEhda6j6cf0EO6NtMrYj8oCB_m0KZn_3mcAkd9H3CoLhMn2Y2b8RmW9Zhlybj_LMWqrQ/exec';
const API_SPJ = 'https://script.google.com/macros/s/AKfycbyE0dBi4Wa6I2OxJbI6w0KVJF97D1-hpXp29LPBJmXH0TuHZYIFAHxb0GlRJxKlOxQf/exec';

const UNITS = [
    'Sekretariat','Bidang Koperasi','Bidang UKM',
    'Bidang Usaha Mikro','Bidang Kewirausahaan','Balai Layanan Usaha Terpadu KUMKM'
];
const US = {
    'Sekretariat':'Sekretariat','Bidang Koperasi':'Bid. Koperasi',
    'Bidang UKM':'Bid. UKM','Bidang Usaha Mikro':'Bid. Usaha Mikro',
    'Bidang Kewirausahaan':'Bid. Kewirausahaan','Balai Layanan Usaha Terpadu KUMKM':'Balai KUMKM'
};
const MONTHS = ['JANUARI','FEBRUARI','MARET','APRIL','MEI','JUNI','JULI','AGUSTUS','SEPTEMBER','OKTOBER','NOVEMBER','DESEMBER'];
const MOS    = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agt','Sep','Okt','Nov','Des'];

// ‚òÖ Monev NOW included in MODS and total
const MODS = [
    {key:'bbm',       label:'BBM',          color:'#0ea5e9', max:5  },
    {key:'kendaraan', label:'Kendaraan',     color:'#f59e0b', max:10 },
    {key:'ruang',     label:'Ruang Rapat',   color:'#8b5cf6', max:5  },
    {key:'kearsipan', label:'Kearsipan',     color:'#22c55e', max:5  },
    {key:'spj',       label:'SPJ Keuangan',  color:'#10b981', max:35 },
    {key:'monev',     label:'Monev',         color:'#ec4899', max:40 },
];
const TOTAL_MAX = 100; // ‚òÖ Updated to 100
const UC = ['#3b82f6','#f59e0b','#8b5cf6','#ef4444','#10b981','#ec4899'];

let S = { bulan:'', scores:{}, allMonth:{}, loading:false };
let C = {};
let activeCat = 'bbm';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
    const u = JSON.parse(localStorage.getItem('user')||'{}');
    document.getElementById('adminName').textContent  = u.name  || 'Administrator';
    document.getElementById('adminEmail').textContent = u.email || 'admin@dinas.gov.id';

    const now = new Date();
    document.getElementById('bulanSel').value = MONTHS[now.getMonth()];
    S.bulan = MONTHS[now.getMonth()];
    document.getElementById('hdDate').textContent = now.toLocaleDateString('id-ID',{weekday:'long',year:'numeric',month:'long',day:'numeric'});

    buildCatRow();
    loadAll();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê API ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function api(url, params) {
    return new Promise((res, rej) => {
        const cb = '__x' + Date.now() + (Math.random()*9999|0);
        const qs = new URLSearchParams({...params, callback:cb}).toString();
        const s  = document.createElement('script');
        let done = false;
        const clean = () => { done=true; delete window[cb]; s.parentNode?.removeChild(s); };
        window[cb] = d => { clean(); res(d); };
        s.onerror  = () => { clean(); rej(new Error('net')); };
        s.src = url+'?'+qs;
        setTimeout(() => { if (!done) { clean(); rej(new Error('timeout')); } }, 20000);
        document.head.appendChild(s);
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOAD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadAll() {
    if (S.loading) return;
    S.loading = true; setRefLoading(true);
    S.bulan = document.getElementById('bulanSel').value;
    const bL = cap(S.bulan);
    document.getElementById('secNote').textContent = bL;
    document.getElementById('stkNote').textContent = bL;

    try {
        const [roomR,vkR,vbR,bbmR,docsR,spjR] = await Promise.allSettled([
            api(API_OP,  {action:'getRoomScores'}),
            api(API_OP,  {action:'getVehicleScores',jenis:'KUNCI'}),
            api(API_OP,  {action:'getVehicleScores',jenis:'BERSIH'}),
            api(API_OP,  {action:'getBBMScores'}),
            api(API_OP,  {action:'getDocuments'}),
            api(API_SPJ, {action:'getAllSPJKeuangan'}),
        ]);

        const sc = {};
        UNITS.forEach(u => { sc[u]={bbm:null,kendaraan:null,ruang:null,kearsipan:null,spj:null,monev:null}; });
        fillScores(sc, S.bulan, roomR, vkR, vbR, bbmR, docsR, spjR);
        S.scores = sc;

        const am = {};
        MONTHS.forEach(m => { am[m]={}; UNITS.forEach(u => { am[m][u]={bbm:null,kendaraan:null,ruang:null,kearsipan:null,spj:null,monev:null}; }); });
        MONTHS.forEach(m => { fillScores(am[m], m, roomR, vkR, vbR, bbmR, docsR, spjR); });
        S.allMonth = am;

        render();
        showToast('Data berhasil dimuat','success');
    } catch(e) {
        console.error(e);
        showToast('Gagal memuat sebagian data','error');
        render();
    } finally {
        S.loading=false; setRefLoading(false);
    }
}

function fillScores(sc, bulan, roomR, vkR, vbR, bbmR, docsR, spjR) {
    if (ok(roomR)) (roomR.value.scores||[]).forEach(s => { if (s.bulan===bulan && sc[s.unit]) sc[s.unit].ruang=s.skorAkhir; });
    const km={},bm={};
    if (ok(vkR)) (vkR.value.scores||[]).forEach(s => { if (s.bulan===bulan) km[s.unit]=s.skorAkhir; });
    if (ok(vbR)) (vbR.value.scores||[]).forEach(s => { if (s.bulan===bulan) bm[s.unit]=s.skorAkhir; });
    UNITS.forEach(u => { const k=km[u]??null, b=bm[u]??null; if (k!==null||b!==null) sc[u].kendaraan=(k??0)+(b??0); });
    if (ok(bbmR)) (bbmR.value.scores||[]).forEach(s => { if (s.bulan===bulan && sc[s.unit]) sc[s.unit].bbm=s.skorAkhir; });
    if (docsR.status==='fulfilled'&&Array.isArray(docsR.value)) {
        const dm={};
        docsR.value.forEach(d => { if (d.bulan?.toUpperCase()===bulan && d.nilai && d.unit) { dm[d.unit]=dm[d.unit]||[]; dm[d.unit].push(parseFloat(d.nilai)||0); } });
        UNITS.forEach(u => { if (dm[u]?.length) sc[u].kearsipan=dm[u].reduce((a,c)=>a+c,0)/dm[u].length; });
    }
    if (ok(spjR)) { const bd=(spjR.value.rekap||{})[bulan]||{}; UNITS.forEach(u => { if (bd[u]?.totalNilai!==undefined) sc[u].spj=bd[u].totalNilai; }); }
    // ‚òÖ Monev from localStorage ‚Äî NOW part of total
    UNITS.forEach(u => {
        try { const d=JSON.parse(localStorage.getItem(`monev_${bulan}_${u}`)||'null'); if (d?.totalScore!==undefined) sc[u].monev=d.totalScore; } catch {}
    });
}

function ok(r) { return r.status==='fulfilled'&&r.value?.success; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render() { renderStats(); renderTable(); renderMobileCards(); renderPanel(); }

function renderStats() {
    const rows = mkRows();
    const wd   = rows.filter(r=>r.has);
    const tots = wd.map(r=>r.tot);
    const avg  = tots.length ? tots.reduce((a,c)=>a+c,0)/tots.length : 0;
    const best = tots.length ? Math.max(...tots) : 0;
    const worst= tots.length ? Math.min(...tots) : 0;
    const bestU= rows.find(r=>r.tot===best)?.unit||'‚Äî';
    document.getElementById('statsRow').innerHTML = `
        <div class="scard" style="--scolor:#3b82f6">
            <div class="scard-label">Rata-rata Total Nilai</div>
            <div class="scard-val">${fn(avg)}</div>
            <div class="scard-sub">dari ${TOTAL_MAX} poin ¬∑ ${((avg/TOTAL_MAX)*100).toFixed(0)}%</div>
        </div>
        <div class="scard" style="--scolor:#10b981">
            <div class="scard-label">Nilai Tertinggi</div>
            <div class="scard-val" style="color:#059669">${fn(best)}</div>
            <div class="scard-sub">${US[bestU]||bestU}</div>
        </div>
        <div class="scard" style="--scolor:#ef4444">
            <div class="scard-label">Nilai Terendah</div>
            <div class="scard-val" style="color:#dc2626">${fn(worst)}</div>
            <div class="scard-sub">perlu perhatian</div>
        </div>
        <div class="scard" style="--scolor:#8b5cf6">
            <div class="scard-label">Divisi Terdata</div>
            <div class="scard-val">${wd.length}</div>
            <div class="scard-sub">dari ${UNITS.length} divisi</div>
        </div>`;
}

function renderTable() {
    const rows = mkRows();
    rows.sort((a,b) => { if (a.has!==b.has) return a.has?-1:1; return b.tot-a.tot; });
    if (rows.every(r=>!r.has)) {
        document.getElementById('rekapTbody').innerHTML=`<tr><td colspan="10" class="empty">üì≠ Belum ada data untuk bulan <strong>${cap(S.bulan)}</strong></td></tr>`;
        return;
    }
    document.getElementById('rekapTbody').innerHTML = rows.map((r,i) => {
        const pct = r.has?(r.tot/TOTAL_MAX*100):0;
        const pc  = pct>=80?'#10b981':pct>=60?'#3b82f6':pct>=40?'#f59e0b':'#ef4444';
        const cell = (key,max) => {
            const v=r.vals[key];
            if (v===null) return `<td class="c"><span class="chip chip-none">‚Äî</span></td>`;
            const p=v/max*100, cls=p>=80?'chip-great':p>=60?'chip-good':p>=40?'chip-fair':'chip-poor';
            return `<td class="c"><span class="chip ${cls}">${fn(v)}</span></td>`;
        };
        const tc=!r.has?'tnone':pct>=80?'tgreat':pct>=60?'tgood':pct>=40?'tfair':'tpoor';
        return `<tr>
            <td><span class="rank">${i+1}</span></td>
            <td style="font-weight:600;min-width:160px">${r.unit}</td>
            ${cell('bbm',5)}${cell('kendaraan',10)}${cell('ruang',5)}${cell('kearsipan',5)}${cell('spj',35)}${cell('monev',40)}
            <td class="c"><span class="tchip ${tc}">${r.has?fn(r.tot):'‚Äî'}</span></td>
            <td><div class="prog-row"><div class="prog-bar"><div class="prog-fill" style="width:${pct.toFixed(0)}%;background:${pc}"></div></div><span class="prog-lbl">${r.has?pct.toFixed(0)+'%':'‚Äî'}</span></div></td>
        </tr>`;
    }).join('');
}

function renderMobileCards() {
    const rows = mkRows();
    rows.sort((a,b) => { if (a.has!==b.has) return a.has?-1:1; return b.tot-a.tot; });
    const container = document.getElementById('mobileRekap');
    if (rows.every(r=>!r.has)) { container.innerHTML=`<div class="empty">üì≠ Belum ada data bulan <strong>${cap(S.bulan)}</strong></div>`; return; }

    container.innerHTML = rows.map((r,i) => {
        const pct = r.has?(r.tot/TOTAL_MAX*100):0;
        const pc  = pct>=80?'#10b981':pct>=60?'#3b82f6':pct>=40?'#f59e0b':'#ef4444';
        const tc  = !r.has?'tnone':pct>=80?'tgreat':pct>=60?'tgood':pct>=40?'tfair':'tpoor';

        const mitem = (label,key,max,color) => {
            const v=r.vals[key];
            const disp = v!==null ? fn(v)+'/'+max : '‚Äî';
            const itemColor = v!==null && (v/max*100)>=80 ? '#059669' : (v!==null && (v/max*100)>=60 ? '#1d4ed8' : (v!==null ? '#92400e' : '#9aa3bf'));
            return `<div class="mitem">
                <div class="mitem-label"><span style="color:${color}">‚óè</span> ${label}</div>
                <div class="mitem-val" style="color:${itemColor}">${disp}</div>
            </div>`;
        };

        return `<div class="mcard">
            <div class="mcard-head">
                <div>
                    <span class="rank" style="margin-right:6px">${i+1}</span>
                    <span class="mcard-name">${r.unit}</span>
                </div>
                <span class="tchip ${tc}">${r.has?fn(r.tot)+'/100':'‚Äî'}</span>
            </div>
            <div class="mcard-grid">
                ${mitem('BBM','bbm',5,'#0ea5e9')}
                ${mitem('Kendaraan','kendaraan',10,'#f59e0b')}
                ${mitem('Ruang Rapat','ruang',5,'#8b5cf6')}
                ${mitem('Kearsipan','kearsipan',5,'#22c55e')}
                ${mitem('SPJ Keuangan','spj',35,'#10b981')}
                ${mitem('Monev','monev',40,'#ec4899')}
            </div>
            <div class="mcard-prog">
                <div class="mprog-label">
                    <span>Progress</span>
                    <span style="color:${pc}">${r.has?pct.toFixed(0)+'%':'‚Äî'}</span>
                </div>
                <div class="mprog-bar"><div class="mprog-fill" style="width:${pct.toFixed(0)}%;background:${pc}"></div></div>
            </div>
        </div>`;
    }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHARTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPanel() {
    const panels=['pTotal','pTrend','pCat','pProfil'];
    const active = panels.find(id=>document.getElementById(id).hasAttribute('data-active'))||'pTotal';
    if (active==='pTotal') drawTotal();
    else if (active==='pTrend') drawTrend();
    else if (active==='pCat')   drawCat();
    else if (active==='pProfil') drawProfil();
}

function goTab(name,btn) {
    document.querySelectorAll('.ctab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const map={total:'pTotal',trend:'pTrend',cat:'pCat',profil:'pProfil'};
    ['pTotal','pTrend','pCat','pProfil'].forEach(id=>{ const el=document.getElementById(id); el.style.display='none'; el.removeAttribute('data-active'); });
    const el=document.getElementById(map[name]);
    el.style.display=''; el.setAttribute('data-active','1');
    if (name==='total') drawTotal();
    else if (name==='trend') drawTrend();
    else if (name==='cat')   drawCat();
    else if (name==='profil') drawProfil();
}

function drawTotal() {
    kill('cStacked'); kill('cRadar');
    const labels = UNITS.map(u=>US[u]);
    const ds = MODS.map(m=>({ label:m.label, data:UNITS.map(u=>+(S.scores[u]?.[m.key]??0)), backgroundColor:m.color+'bb', borderColor:m.color, borderWidth:1, borderRadius:3 }));
    C.cStacked = new Chart(document.getElementById('cStacked'),{
        type:'bar', data:{labels,datasets:ds},
        options:{ responsive:true, maintainAspectRatio:false,
            plugins:{ legend:{position:'top',labels:{font:{family:'Plus Jakarta Sans',size:11},padding:10,boxWidth:10}}, tooltip:{callbacks:{label:c=>`${c.dataset.label}: ${c.raw} poin`}} },
            scales:{
                x:{stacked:true,grid:{display:false},ticks:{font:{family:'Plus Jakarta Sans',size:11}}},
                y:{stacked:true,max:TOTAL_MAX,grid:{color:'#f0f2f7'},ticks:{font:{family:'Plus Jakarta Sans',size:11}},title:{display:true,text:'Total (/100)',font:{family:'Plus Jakarta Sans',size:11}}}
            }
        }
    });
    const rd=MODS.map(m=>{ const vs=UNITS.map(u=>S.scores[u]?.[m.key]??null).filter(v=>v!==null); return vs.length?+((vs.reduce((a,c)=>a+c,0)/vs.length/m.max*100).toFixed(1)):0; });
    C.cRadar = new Chart(document.getElementById('cRadar'),{
        type:'radar',
        data:{labels:MODS.map(m=>m.label),datasets:[{label:'Rata-rata %',data:rd,backgroundColor:'rgba(15,23,42,.07)',borderColor:'#1d4ed8',borderWidth:2,pointBackgroundColor:MODS.map(m=>m.color),pointBorderColor:'#fff',pointBorderWidth:2,pointRadius:5}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>`${c.raw}%`}}},scales:{r:{min:0,max:100,ticks:{stepSize:25,font:{size:10},color:'#9aa3bf'},pointLabels:{font:{family:'Plus Jakarta Sans',size:11}},grid:{color:'#e4e7ef'}}}}
    });
}

function drawTrend() {
    kill('cTrend');
    Object.keys(C).filter(k=>k.startsWith('sm_')).forEach(k=>{C[k].destroy();delete C[k];});
    const ds=UNITS.map((u,i)=>({ label:US[u], data:MONTHS.map(m=>{ const sc=S.allMonth[m]?.[u]; if(!sc) return null; let t=0,h=false; MODS.forEach(mo=>{if(sc[mo.key]!==null&&sc[mo.key]!==undefined){t+=sc[mo.key];h=true;}}); return h?+t.toFixed(2):null; }), borderColor:UC[i],backgroundColor:UC[i]+'22',borderWidth:2,pointRadius:4,pointBackgroundColor:UC[i],pointBorderColor:'#fff',pointBorderWidth:2,fill:false,tension:.35,spanGaps:true }));
    C.cTrend=new Chart(document.getElementById('cTrend'),{type:'line',data:{labels:MOS,datasets:ds},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{font:{family:'Plus Jakarta Sans',size:11},padding:10,boxWidth:10}},tooltip:{callbacks:{label:c=>c.raw!==null?`${c.dataset.label}: ${c.raw}/${TOTAL_MAX}`:'‚Äî'}}},scales:{x:{grid:{color:'#f8f9fc'},ticks:{font:{family:'Plus Jakarta Sans',size:11}}},y:{min:0,max:TOTAL_MAX,grid:{color:'#f0f2f7'},ticks:{font:{family:'Plus Jakarta Sans',size:11}},title:{display:true,text:'Total (/100)',font:{family:'Plus Jakarta Sans',size:11}}}}}});
    const grid=document.getElementById('trendSmall');
    grid.innerHTML=UNITS.map((u,i)=>`<div class="card"><div class="card-head" style="padding:12px 16px"><span class="card-title" style="color:${UC[i]};font-size:13px">${US[u]}</span></div><div class="card-body" style="padding:12px"><div class="cw h230"><canvas id="sm_${i}"></canvas></div></div></div>`).join('');
    UNITS.forEach((u,i)=>{
        const smDs=MODS.map(m=>({label:m.label,data:MONTHS.map(mo=>+(S.allMonth[mo]?.[u]?.[m.key]??0).toFixed(2)),backgroundColor:m.color+'aa',borderColor:m.color,borderWidth:1,borderRadius:2}));
        C[`sm_${i}`]=new Chart(document.getElementById(`sm_${i}`),{type:'bar',data:{labels:MOS,datasets:smDs},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>`${c.dataset.label}: ${c.raw}`}}},scales:{x:{stacked:true,grid:{display:false},ticks:{font:{family:'Plus Jakarta Sans',size:9}}},y:{stacked:true,max:TOTAL_MAX,grid:{color:'#f0f2f7'},ticks:{font:{family:'Plus Jakarta Sans',size:9}}}}}});
    });
}

function drawCat() {
    kill('cCat1'); kill('cCat2');
    const mod=MODS.find(m=>m.key===activeCat);
    document.getElementById('catT1').textContent=`${mod.label} ‚Äî ${cap(S.bulan)}`;
    document.getElementById('catN1').textContent=`Maks. ${mod.max} poin`;
    document.getElementById('catT2').textContent=`${mod.label} ‚Äî Tren Lintas Bulan`;
    C.cCat1=new Chart(document.getElementById('cCat1'),{type:'bar',data:{labels:UNITS.map(u=>US[u]),datasets:[{label:mod.label,data:UNITS.map(u=>+(S.scores[u]?.[activeCat]??0).toFixed(2)),backgroundColor:UNITS.map(u=>{const v=S.scores[u]?.[activeCat]??0,p=v/mod.max*100;return p>=80?'#10b981bb':p>=60?'#3b82f6bb':p>=40?'#f59e0bbb':'#ef4444bb';}),borderColor:mod.color,borderWidth:2,borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>`${c.raw} / ${mod.max} (${(c.raw/mod.max*100).toFixed(0)}%)`}}},scales:{x:{grid:{display:false},ticks:{font:{family:'Plus Jakarta Sans',size:12}}},y:{min:0,max:mod.max,grid:{color:'#f0f2f7'},ticks:{font:{family:'Plus Jakarta Sans',size:11}},title:{display:true,text:`/${mod.max}`,font:{family:'Plus Jakarta Sans',size:11}}}}}});
    const ds2=UNITS.map((u,i)=>({label:US[u],data:MONTHS.map(m=>+(S.allMonth[m]?.[u]?.[activeCat]??0).toFixed(2)),borderColor:UC[i],backgroundColor:UC[i]+'22',borderWidth:2,pointRadius:4,pointBackgroundColor:UC[i],pointBorderColor:'#fff',pointBorderWidth:2,fill:false,tension:.35,spanGaps:true}));
    C.cCat2=new Chart(document.getElementById('cCat2'),{type:'line',data:{labels:MOS,datasets:ds2},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{font:{family:'Plus Jakarta Sans',size:11},padding:8,boxWidth:10}},tooltip:{callbacks:{label:c=>`${c.dataset.label}: ${c.raw}/${mod.max}`}}},scales:{x:{grid:{color:'#f8f9fc'},ticks:{font:{family:'Plus Jakarta Sans',size:11}}},y:{min:0,max:mod.max,grid:{color:'#f0f2f7'},ticks:{font:{family:'Plus Jakarta Sans',size:11}}}}}});
}

function drawProfil() {
    Object.keys(C).filter(k=>k.startsWith('rd_')).forEach(k=>{C[k].destroy();delete C[k];});
    const grid=document.getElementById('radarGrid');
    grid.innerHTML=UNITS.map((u,i)=>`<div class="card"><div class="card-head" style="padding:12px 16px"><span class="card-title" style="color:${UC[i]}">${US[u]}</span><span class="card-note">${cap(S.bulan)}</span></div><div class="card-body" style="padding:12px"><div class="cw h230"><canvas id="rd_${i}"></canvas></div><div style="margin-top:9px;display:flex;flex-wrap:wrap;gap:5px;justify-content:center">${MODS.map(m=>{const v=S.scores[u]?.[m.key]??null;return `<span style="font-size:10px;font-weight:600;color:${m.color}">${m.label}: ${v!==null?fn(v):'‚Äî'}/${m.max}</span>`;}).join('<span style="color:#e4e7ef">|</span>')}</div></div></div>`).join('');
    UNITS.forEach((u,i)=>{
        const data=MODS.map(m=>{const v=S.scores[u]?.[m.key]??null;return v!==null?+((v/m.max)*100).toFixed(1):0;});
        C[`rd_${i}`]=new Chart(document.getElementById(`rd_${i}`),{type:'radar',data:{labels:MODS.map(m=>m.label),datasets:[{label:US[u],data,backgroundColor:UC[i]+'22',borderColor:UC[i],borderWidth:2,pointBackgroundColor:MODS.map(m=>m.color),pointBorderColor:'#fff',pointBorderWidth:2,pointRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>`${c.raw}%`}}},scales:{r:{min:0,max:100,ticks:{stepSize:50,font:{size:9},color:'#9aa3bf'},pointLabels:{font:{family:'Plus Jakarta Sans',size:10}},grid:{color:'#e4e7ef'}}}}});
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CAT BUTTONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildCatRow() {
    const wrap=document.getElementById('catRow');
    MODS.forEach(m=>{
        const b=document.createElement('button');
        b.className='catbtn'; b.textContent=m.label;
        if (m.key===activeCat){b.style.background=m.color;b.style.color='#fff';}
        b.onclick=()=>{
            activeCat=m.key;
            wrap.querySelectorAll('.catbtn').forEach(bb=>{bb.style.background='';bb.style.color='';});
            b.style.background=m.color; b.style.color='#fff';
            drawCat();
        };
        wrap.appendChild(b);
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function mkRows() {
    return UNITS.map(u=>{
        const s=S.scores[u]||{}; let tot=0,has=false; const vals={};
        MODS.forEach(m=>{ vals[m.key]=s[m.key]??null; if(vals[m.key]!==null){tot+=vals[m.key];has=true;} });
        return {unit:u,vals,tot,has};
    });
}
function fn(v) { if(v===null||v===undefined) return '‚Äî'; const n=parseFloat(v); return isNaN(n)?'‚Äî':(n%1===0?String(n):n.toFixed(1)); }
function cap(s) { return s?s[0]+s.slice(1).toLowerCase():''; }
function kill(id) { if(C[id]){C[id].destroy();delete C[id];} }
function onBulanChange() { S.bulan=document.getElementById('bulanSel').value; loadAll(); }
function setRefLoading(on) { const b=document.getElementById('btnRef'); b.disabled=on; }
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sOverlay').classList.toggle('active'); }
function logout() { if(confirm('Yakin keluar?')){localStorage.clear();window.location.href='login.html';} }

function showToast(msg, type='') {
    const box=document.getElementById('toastBox');
    const t=document.createElement('div');
    t.className=`toast ${type}`;
    const icon=type==='success'?'<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>':'<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>';
    t.innerHTML=`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">${icon}</svg><span>${msg}</span>`;
    box.appendChild(t);
    setTimeout(()=>{t.style.opacity='0';t.style.transition='opacity .3s';setTimeout(()=>t.remove(),300);},3500);
}

document.getElementById('pTotal').setAttribute('data-active','1');
</script>
</body>
</html>
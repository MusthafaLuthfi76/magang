<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penilaian Monitoring & Evaluasi - Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #1e293b;
            display: flex;
            min-height: 100vh;
        }

        /* ============ TOAST ============ */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { background: white; padding: 16px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 10px; min-width: 300px; animation: slideIn 0.3s ease-out; display: flex; align-items: center; gap: 12px; }
        .toast.success { border-left: 4px solid #10b981; }
        .toast.error { border-left: 4px solid #ef4444; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* ============ SIDEBAR ============ */
        .sidebar {
            width: 252px;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            left: 0; top: 0;
            z-index: 100;
        }

        .sidebar-header { padding: 20px 16px; border-bottom: 1px solid #e5e7eb; }
        .sidebar-header-content { display: flex; align-items: center; gap: 12px; }
        .sidebar-icon { width: 40px; height: 40px; background: #0f172a; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .sidebar-title { font-size: 16px; font-weight: 600; color: #1e293b; }
        .sidebar-subtitle { font-size: 12px; color: #64748b; }
        .sidebar-nav { flex: 1; padding: 16px 12px; display: flex; flex-direction: column; gap: 4px; overflow-y: auto; }
        .sidebar-footer { padding: 16px 12px; border-top: 1px solid #e5e7eb; }

        .nav-item {
            display: flex; align-items: center; gap: 14px;
            padding: 12px 16px; border-radius: 10px; font-weight: 500; font-size: 15px;
            color: #0f172a; text-decoration: none; position: relative;
            transition: all 0.15s ease;
        }
        .nav-item:hover { background: #f8fafc; }
        .nav-item.active { background: #f1f5f9; }
        .nav-item.active::before {
            content: ''; position: absolute; left: 0; top: 8px; bottom: 8px;
            width: 4px; background: #0f172a; border-radius: 0 4px 4px 0;
        }

        .nav-icon { width: 20px; height: 20px; stroke: currentColor; fill: none; stroke-width: 1.8; }

        /* ============ MAIN ============ */
        .main-content { flex: 1; display: flex; flex-direction: column; margin-left: 252px; }
        .header { background: white; border-bottom: 1px solid #e5e7eb; padding: 24px 32px; }
        .header-title { font-size: 24px; font-weight: 600; color: #1e293b; margin-bottom: 4px; }
        .header-subtitle { font-size: 14px; color: #64748b; }
        .container { padding: 24px 32px; width: 100%; }

        /* ============ TABS ============ */
        .tabs { display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid #e5e7eb; overflow-x: auto; }
        .tab { padding: 12px 24px; border: none; background: none; cursor: pointer; font-size: 15px; font-weight: 500; color: #64748b; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.2s; font-family: 'Inter', sans-serif; white-space: nowrap; }
        .tab:hover { color: #1e293b; }
        .tab.active { color: #0f172a; border-bottom-color: #0f172a; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ============ CARDS ============ */
        .card { background: white; border-radius: 8px; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 24px; }
        .card-header { padding: 20px 24px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
        .card-title { font-size: 18px; font-weight: 600; color: #1e293b; }
        .card-content { padding: 24px; }

        /* ============ STATS GRID ============ */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card { padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb; background: white; }
        .stat-label { font-size: 13px; color: #64748b; margin-bottom: 8px; }
        .stat-value { font-size: 32px; font-weight: 700; color: #1e293b; }

        /* ============ FORM ============ */
        .filter-container { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .select-input, .search-input, .form-input { padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; font-family: 'Inter', sans-serif; }
        .select-input { width: 180px; }
        .input-label { display: block; font-size: 13px; font-weight: 500; color: #64748b; margin-bottom: 6px; }
        .form-input { width: 100%; }
        .form-group { margin-bottom: 16px; }
        .form-textarea { width: 100%; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; font-family: 'Inter', sans-serif; resize: vertical; min-height: 80px; }

        /* ============ TABLE ============ */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px 16px; font-size: 12px; font-weight: 600; color: #64748b; background: #f8fafc; border-bottom: 1px solid #e5e7eb; }
        td { padding: 14px 16px; font-size: 14px; color: #1e293b; border-bottom: 1px solid #f1f5f9; }
        tbody tr:hover { background: #fafbfc; }

        /* ============ BUTTONS ============ */
        .btn { padding: 8px 16px; border-radius: 6px; border: 1px solid #e5e7eb; font-size: 14px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; background: white; color: #1e293b; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .btn:hover { background: #f8fafc; border-color: #cbd5e1; }
        .btn-primary { background: #0f172a; color: white; border-color: #0f172a; }
        .btn-primary:hover { background: #1e293b; }
        .btn-success { background: #10b981; color: white; border-color: #10b981; }
        .btn-success:hover { background: #059669; }
        .btn-sm { padding: 5px 12px; font-size: 12px; }

        /* ============ MODAL ============ */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal { background: white; border-radius: 12px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid #e5e7eb; }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-content { padding: 24px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; gap: 12px; }

        /* ============ SCORE INPUT ============ */
        .score-section { background: #f8fafc; border-radius: 8px; padding: 16px; margin-bottom: 16px; border-left: 4px solid #3b82f6; }
        .score-section-title { font-weight: 700; font-size: 14px; color: #1e293b; margin-bottom: 12px; }
        .score-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .score-preview { background: white; border: 2px solid #e5e7eb; border-radius: 8px; padding: 16px; text-align: center; margin-bottom: 16px; }
        .score-total { font-size: 48px; font-weight: 800; color: #1F4E79; line-height: 1; }
        .score-max { font-size: 14px; color: #64748b; }
        .score-breakdown { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 12px; }
        .score-item { text-align: center; padding: 10px; background: #f8fafc; border-radius: 6px; }
        .score-item-label { font-size: 11px; color: #64748b; }
        .score-item-val { font-size: 18px; font-weight: 700; color: #1e293b; }

        /* ============ REKAPITULASI TABLE ============ */
        .rekap-table th { background: #1F4E79; color: white; text-align: center; }
        .rekap-table td { text-align: center; }
        .rekap-good { color: #065f46; font-weight: 700; }
        .rekap-bad { color: #991b1b; font-weight: 700; }
        .rekap-table tr:last-child { background: #f0f7ff; font-weight: 700; }

        /* ============ CHART ============ */
        .chart-container { position: relative; height: 350px; }
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }

        /* ============ BADGES ============ */
        .badge { padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 500; display: inline-block; }
        .badge-green { background: #d1fae5; color: #065f46; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-yellow { background: #fef3c7; color: #92400e; }

        /* ============ USER / LOGOUT ============ */
        .user-info { padding: 0 12px; margin-bottom: 16px; }
        .user-name { font-size: 14px; font-weight: 600; color: #1e293b; }
        .user-email { font-size: 12px; color: #64748b; }
        .logout-btn { width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; background: white; cursor: pointer; font-size: 14px; font-weight: 500; color: #1e293b; display: flex; align-items: center; justify-content: center; gap: 8px; font-family: 'Inter', sans-serif; }
        .logout-btn:hover { background: #f8fafc; }

        .mobile-menu-btn { display: none; position: fixed; top: 20px; left: 20px; z-index: 101; background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px 12px; cursor: pointer; }

        .radio-group { display: flex; gap: 16px; flex-wrap: wrap; margin-top: 8px; }
        .radio-label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; }
        .radio-label input[type="radio"] { width: 16px; height: 16px; cursor: pointer; }

        .info-banner { background: #eff6ff; border-left: 4px solid #3b82f6; padding: 12px 16px; border-radius: 6px; margin-bottom: 16px; font-size: 13px; color: #1e3a8a; }

        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; }

        @media (max-width: 1023px) {
            .mobile-menu-btn { display: block; }
            .sidebar { transform: translateX(-100%); transition: transform 0.3s; }
            .sidebar.mobile-open { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .charts-grid { grid-template-columns: 1fr; }
            .score-row { grid-template-columns: 1fr; }
            .score-breakdown { grid-template-columns: 1fr 1fr; }
        }

        @media (max-width: 640px) {
            .score-breakdown { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞ Menu</button>

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-header-content">
                <div class="sidebar-icon">
                    <svg viewBox="0 0 24 24" style="width:20px;height:20px;stroke:white;fill:none;stroke-width:1.8">
                        <rect x="3" y="3" width="7" height="7" rx="1"/>
                        <rect x="14" y="3" width="7" height="7" rx="1"/>
                        <rect x="3" y="14" width="7" height="7" rx="1"/>
                        <rect x="14" y="14" width="7" height="7" rx="1"/>
                    </svg>
                </div>
                <div>
                    <div class="sidebar-title">Admin Panel</div>
                    <div class="sidebar-subtitle">Dinas Koperasi UKM</div>
                </div>
            </div>
        </div>

        <div class="sidebar-nav">
            <a href="admin-dashboard.html" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
                Dashboard
            </a>
            <a href="admin-requests.html" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M14 3H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><path d="M14 3v6h6"/></svg>
                Kendaraan Dinas
            </a>
            <a href="admin-voucher-bbm.html" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                Voucher BBM
            </a>
            <a href="admin-ruang-rapat.html" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                Ruang Rapat
            </a>
            <a href="admin-kearsipan.html" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                Kearsipan Internal
            </a>
            <a href="admin-spj-keuangan.html" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                SPJ Keuangan
            </a>
            <a href="admin-penilaian-monev.html" class="nav-item active">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                Penilaian Monev
            </a>
        </div>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-name" id="admin-name">Administrator</div>
                <div class="user-email" id="admin-email">admin@dinas.gov.id</div>
            </div>
            <button onclick="logout()" class="logout-btn">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                Keluar
            </button>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div class="header">
            <h1 class="header-title">Penilaian Monitoring & Evaluasi</h1>
            <p class="header-subtitle">Sistem penilaian 6 indikator dengan total maksimal 40 poin per unit</p>
        </div>

        <div class="container">
            <!-- TABS -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('input', event)">üì• Input Penilaian</button>
                <button class="tab" onclick="switchTab('rekap', event)">üìä Rekapitulasi</button>
            </div>

            <!-- ============ TAB 1: INPUT ============ -->
            <div id="tab-input" class="tab-content active">

                <div class="stats-grid">
                    <div class="stat-card" style="border-left:4px solid #1F4E79;">
                        <div class="stat-label">Skor Maksimum</div>
                        <div class="stat-value">40</div>
                    </div>
                    <div class="stat-card" style="border-left:4px solid #10b981;">
                        <div class="stat-label">Rata-rata Bulan Ini</div>
                        <div class="stat-value" id="avg-score-this-month">‚Äî</div>
                    </div>
                    <div class="stat-card" style="border-left:4px solid #f59e0b;">
                        <div class="stat-label">Unit Dinilai</div>
                        <div class="stat-value" id="units-assessed">0</div>
                    </div>
                    <div class="stat-card" style="border-left:4px solid #ef4444;">
                        <div class="stat-label">Unit Belum Dinilai</div>
                        <div class="stat-value" id="units-pending">6</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Input Nilai Kinerja Monev Per Unit</h2>
                        <div class="filter-container">
                            <select class="select-input" id="select-bulan-input">
                                <option value="">Pilih Bulan</option>
                                <option value="JANUARI">Januari</option>
                                <option value="FEBRUARI">Februari</option>
                                <option value="MARET">Maret</option>
                                <option value="APRIL">April</option>
                                <option value="MEI">Mei</option>
                                <option value="JUNI">Juni</option>
                                <option value="JULI">Juli</option>
                                <option value="AGUSTUS">Agustus</option>
                                <option value="SEPTEMBER">September</option>
                                <option value="OKTOBER">Oktober</option>
                                <option value="NOVEMBER">November</option>
                                <option value="DESEMBER">Desember</option>
                            </select>
                        </div>
                    </div>
                    <div style="overflow-x:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Unit</th>
                                    <th>Bulan</th>
                                    <th>Ketepatan Waktu (5)</th>
                                    <th>Kelengkapan (5)</th>
                                    <th>Fisik (10)</th>
                                    <th>Keuangan (10)</th>
                                    <th>Partisipasi (5)</th>
                                    <th>Tindak Lanjut (5)</th>
                                    <th>Total (max 40)</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="input-tbody">
                                <tr><td colspan="10" style="text-align:center;padding:40px;color:#94a3b8;">Pilih bulan untuk melihat data</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ============ TAB 2: REKAPITULASI ============ -->
            <div id="tab-rekap" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Rekapitulasi Nilai Kinerja Monitoring & Evaluasi</h2>
                        <div class="filter-container">
                            <select class="select-input" id="select-bulan-rekap">
                                <option value="">Semua Bulan</option>
                                <option value="JANUARI">Januari</option>
                                <option value="FEBRUARI">Februari</option>
                                <option value="MARET">Maret</option>
                                <option value="APRIL">April</option>
                                <option value="MEI">Mei</option>
                                <option value="JUNI">Juni</option>
                                <option value="JULI">Juli</option>
                                <option value="AGUSTUS">Agustus</option>
                                <option value="SEPTEMBER">September</option>
                                <option value="OKTOBER">Oktober</option>
                                <option value="NOVEMBER">November</option>
                                <option value="DESEMBER">Desember</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="charts-grid">
                            <div class="card" style="margin:0;">
                                <div class="card-header" style="padding:16px;"><h3 style="font-size:15px;font-weight:600;">Distribusi Nilai Per Indikator</h3></div>
                                <div class="card-content"><div class="chart-container"><canvas id="chartIndikator"></canvas></div></div>
                            </div>
                            <div class="card" style="margin:0;">
                                <div class="card-header" style="padding:16px;"><h3 style="font-size:15px;font-weight:600;">Total Nilai Per Unit (Maks 40)</h3></div>
                                <div class="card-content"><div class="chart-container"><canvas id="chartTotal"></canvas></div></div>
                            </div>
                        </div>

                        <div style="overflow-x:auto;">
                            <table class="rekap-table">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Indikator Penilaian</th>
                                        <th>BLUT</th>
                                        <th>Bid. Kewirausahaan</th>
                                        <th>Bid. Koperasi</th>
                                        <th>Bid. UKM</th>
                                        <th>Bid. Usaha Mikro</th>
                                        <th>Sekretariat</th>
                                    </tr>
                                </thead>
                                <tbody id="rekap-tbody">
                                    <tr><td colspan="8" style="text-align:center;padding:40px;color:#94a3b8;">Memuat data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ MODAL INPUT ============ -->
    <div id="inputModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Input Penilaian Monitoring & Evaluasi</h2>
                <p style="font-size:13px;color:#64748b;margin-top:4px;" id="modal-bulan-label">‚Äî</p>
            </div>
            <div class="modal-content">
                <div class="info-banner">
                    üìä <strong>Sistem Penilaian:</strong> Total maksimal 40 poin dari 6 indikator utama dengan pengurangan nilai sesuai keterlambatan dan deviasi
                </div>

                <!-- HIDDEN UNIT FIELD -->
                <input type="hidden" id="input-unit">

                <!-- 1. KETEPATAN WAKTU -->
                <div class="score-section">
                    <div class="score-section-title">1Ô∏è‚É£ Ketepatan Waktu (Maks 5 poin)</div>
                    
                    <div style="margin-bottom: 12px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                        <div style="font-size: 13px; color: #64748b; margin-bottom: 8px;">
                            Apakah penyampaian data tepat waktu? (max 3 bulan berikutnya)
                        </div>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="ketepatan-waktu" value="tepat" checked>
                                <span>Tepat Waktu (5 poin)</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="ketepatan-waktu" value="terlambat">
                                <span>Ada Keterlambatan</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group" id="keterlambatan-group" style="display: none;">
                        <label class="input-label">‚è∞ Keterlambatan (pilih kategori)</label>
                        <select class="form-input" id="keterlambatan">
                            <option value="3">< 5 hari (-3 poin)</option>
                            <option value="5">‚â• 5 hari (-5 poin)</option>
                        </select>
                    </div>
                </div>

                <!-- 2. KELENGKAPAN DATA -->
                <div class="score-section" style="border-left-color: #8b5cf6;">
                    <div class="score-section-title">2Ô∏è‚É£ Kelengkapan Data (Maks 5 poin)</div>
                    
                    <div style="margin-bottom: 12px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                        <div style="font-size: 13px; color: #64748b; margin-bottom: 8px;">
                            Apakah seluruh komponen data monev sudah lengkap?
                        </div>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="kelengkapan-data" value="lengkap" checked>
                                <span>Lengkap (5 poin)</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="kelengkapan-data" value="kurang">
                                <span>Ada Kekurangan</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group" id="kualitas-data-group" style="display: none;">
                        <label class="input-label">üìã Kualitas Data (pilih kategori)</label>
                        <select class="form-input" id="kualitas-data">
                            <option value="2">Keterlisian 50% - 90% (-2 poin)</option>
                            <option value="3">Keterlisian < 50% (-3 poin)</option>
                        </select>
                    </div>
                </div>

                <!-- 3. CAPAIAN FISIK -->
                <div class="score-section" style="border-left-color: #10b981;">
                    <div class="score-section-title">3Ô∏è‚É£ Capaian Fisik (Maks 10 poin)</div>
                    
                    <div style="margin-bottom: 12px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                        <div style="font-size: 13px; color: #64748b; margin-bottom: 8px;">
                            Apakah capaian fisik sesuai target? (deviasi < 5%)
                        </div>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="capaian-fisik" value="sesuai" checked>
                                <span>Sesuai Target (10 poin)</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="capaian-fisik" value="deviasi">
                                <span>Ada Deviasi</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group" id="deviasi-fisik-group" style="display: none;">
                        <label class="input-label">üìä Deviasi Fisik (pilih kategori)</label>
                        <select class="form-input" id="deviasi-fisik">
                            <option value="5">Deviasi ‚â• 5% - < 10% (-5 poin)</option>
                            <option value="8">Deviasi ‚â• 10% (-8 poin)</option>
                        </select>
                    </div>
                </div>

                <!-- 4. CAPAIAN KEUANGAN -->
                <div class="score-section" style="border-left-color: #f59e0b;">
                    <div class="score-section-title">4Ô∏è‚É£ Capaian Keuangan (Maks 10 poin)</div>
                    
                    <div style="margin-bottom: 12px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                        <div style="font-size: 13px; color: #64748b; margin-bottom: 8px;">
                            Apakah capaian keuangan sesuai anggaran? (deviasi < 5%)
                        </div>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="capaian-keuangan" value="sesuai" checked>
                                <span>Sesuai Anggaran (10 poin)</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="capaian-keuangan" value="deviasi">
                                <span>Ada Deviasi</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group" id="deviasi-keuangan-group" style="display: none;">
                        <label class="input-label">üí∞ Deviasi Keuangan (pilih kategori)</label>
                        <select class="form-input" id="deviasi-keuangan">
                            <option value="5">Deviasi ‚â• 5% - < 10% (-5 poin)</option>
                            <option value="8">Deviasi ‚â• 10% (-8 poin)</option>
                        </select>
                    </div>
                </div>

                <!-- 5. PARTISIPASI PPTK -->
                <div class="score-section" style="border-left-color: #ec4899;">
                    <div class="score-section-title">5Ô∏è‚É£ Partisipasi PPTK (Maks 5 poin)</div>
                    
                    <div style="margin-bottom: 12px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                        <div style="font-size: 13px; color: #64748b; margin-bottom: 8px;">
                            Partisipasi PPTK dalam Desk Timbal Balik
                        </div>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="partisipasi" value="hadir" checked>
                                <span>PPTK Hadir (5 poin)</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="partisipasi" value="diwakili">
                                <span>Diwakili Staf (-2 poin)</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="partisipasi" value="tidak-hadir">
                                <span>Tidak Hadir (-5 poin)</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 6. TINDAK LANJUT -->
                <div class="score-section" style="border-left-color: #06b6d4;">
                    <div class="score-section-title">6Ô∏è‚É£ Tindak Lanjut (Maks 5 poin)</div>
                    
                    <div style="margin-bottom: 12px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                        <div style="font-size: 13px; color: #64748b; margin-bottom: 8px;">
                            Apakah tindak lanjut pasca Desk Timbal Balik sudah dilaksanakan?
                        </div>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="tindak-lanjut" value="ya" checked>
                                <span>Ya, Ditindaklanjuti (5 poin)</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="tindak-lanjut" value="tidak">
                                <span>Tidak Ditindaklanjuti (-5 poin)</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- SCORE PREVIEW -->
                <div class="score-preview">
                    <div style="font-size:13px;color:#64748b;margin-bottom:8px;">TOTAL NILAI</div>
                    <div class="score-total" id="modal-total-nilai">40</div>
                    <div class="score-max">dari maksimal 40</div>
                    <div class="score-breakdown">
                        <div class="score-item">
                            <div class="score-item-label">Ketepatan Waktu</div>
                            <div class="score-item-val" id="score-waktu">5</div>
                        </div>
                        <div class="score-item">
                            <div class="score-item-label">Kelengkapan</div>
                            <div class="score-item-val" id="score-kelengkapan">5</div>
                        </div>
                        <div class="score-item">
                            <div class="score-item-label">Capaian Fisik</div>
                            <div class="score-item-val" id="score-fisik">10</div>
                        </div>
                        <div class="score-item">
                            <div class="score-item-label">Capaian Keuangan</div>
                            <div class="score-item-val" id="score-keuangan">10</div>
                        </div>
                        <div class="score-item">
                            <div class="score-item-label">Partisipasi</div>
                            <div class="score-item-val" id="score-partisipasi">5</div>
                        </div>
                        <div class="score-item">
                            <div class="score-item-label">Tindak Lanjut</div>
                            <div class="score-item-val" id="score-tindak-lanjut">5</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="input-label">Catatan Tambahan (Opsional)</label>
                    <textarea class="form-textarea" id="input-catatan" placeholder="Catatan tambahan..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('inputModal')" class="btn" style="flex:1;">Batal</button>
                <button onclick="submitInputNilai()" class="btn btn-success" style="flex:1;" id="submit-input-btn">üíæ Simpan Penilaian</button>
            </div>
        </div>
    </div>

    <script>
    // GANTI URL INI DENGAN URL APPS SCRIPT ANDA
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzaoArHCPDFVx-Jvfa430krfrlXoge-JVNGUX_emfwWmXFkT25A_ifgQwFOyuILb465/exec';

    const UNITS = [
        "Balai Layanan Usaha Terpadu KUMKM",
        "Bidang Kewirausahaan",
        "Bidang Koperasi",
        "Bidang UKM",
        "Bidang Usaha Mikro",
        "Sekretariat"
    ];
    const SHORT_UNITS = ['BLUT', 'Kewirausahaan', 'Koperasi', 'UKM', 'Usaha Mikro', 'Sekretariat'];
    const MONTHS = ["JANUARI","FEBRUARI","MARET","APRIL","MEI","JUNI","JULI","AGUSTUS","SEPTEMBER","OKTOBER","NOVEMBER","DESEMBER"];
    const SKOR_MAX = 40;

    // Use localStorage as local storage fallback for demo
    function getLocalData() {
        const raw = localStorage.getItem('monev_data');
        return raw ? JSON.parse(raw) : {};
    }
    function setLocalData(data) {
        localStorage.setItem('monev_data', JSON.stringify(data));
    }

    // Pre-populate demo data (struktur: bulan -> unit -> indikator)
    (function initDemoData() {
        const existing = getLocalData();
        if (Object.keys(existing).length > 0) return;
        
        const demo = {
            "JANUARI": {
                "Balai Layanan Usaha Terpadu KUMKM": { waktu: 5, kelengkapan: 5, fisik: 10, keuangan: 10, partisipasi: 5, tindakLanjut: 5, total: 40, catatan: "Tepat waktu" },
                "Bidang Kewirausahaan": { waktu: 5, kelengkapan: 5, fisik: 10, keuangan: 10, partisipasi: 5, tindakLanjut: 5, total: 40, catatan: "" },
                "Bidang Koperasi": { waktu: 5, kelengkapan: 5, fisik: 10, keuangan: 10, partisipasi: 5, tindakLanjut: 5, total: 40, catatan: "" },
                "Bidang UKM": { waktu: 5, kelengkapan: 5, fisik: 10, keuangan: 10, partisipasi: 5, tindakLanjut: 5, total: 40, catatan: "" },
                "Bidang Usaha Mikro": { waktu: 2, kelengkapan: 3, fisik: 5, keuangan: 5, partisipasi: 3, tindakLanjut: 5, total: 23, catatan: "Terlambat 3 hari" },
                "Sekretariat": { waktu: 5, kelengkapan: 5, fisik: 10, keuangan: 10, partisipasi: 5, tindakLanjut: 5, total: 40, catatan: "" }
            }
        };
        setLocalData(demo);
    })();

    // Calculation function
    function calcMonevScores(keTepatanWaktu, kelengkapanData, capaianFisik, capaianKeuangan, partisipasi, tindakLanjut, keterlambatan, kualitasData, deviasiFisik, deviasiKeuangan) {
        // 1. Ketepatan Waktu (max 5)
        let skorWaktu = 5;
        if (keTepatanWaktu === 'terlambat') {
            const pengurangan = parseInt(keterlambatan) || 0;
            skorWaktu = Math.max(0, 5 - pengurangan);
        }

        // 2. Kelengkapan Data (max 5)
        let skorKelengkapan = 5;
        if (kelengkapanData === 'kurang') {
            const pengurangan = parseInt(kualitasData) || 0;
            skorKelengkapan = Math.max(0, 5 - pengurangan);
        }

        // 3. Capaian Fisik (max 10)
        let skorFisik = 10;
        if (capaianFisik === 'deviasi') {
            const pengurangan = parseInt(deviasiFisik) || 0;
            skorFisik = Math.max(0, 10 - pengurangan);
        }

        // 4. Capaian Keuangan (max 10)
        let skorKeuangan = 10;
        if (capaianKeuangan === 'deviasi') {
            const pengurangan = parseInt(deviasiKeuangan) || 0;
            skorKeuangan = Math.max(0, 10 - pengurangan);
        }

        // 5. Partisipasi (max 5)
        let skorPartisipasi = 5;
        if (partisipasi === 'diwakili') {
            skorPartisipasi = 3;
        } else if (partisipasi === 'tidak-hadir') {
            skorPartisipasi = 0;
        }

        // 6. Tindak Lanjut (max 5)
        let skorTindakLanjut = 5;
        if (tindakLanjut === 'tidak') {
            skorTindakLanjut = 0;
        }

        const total = skorWaktu + skorKelengkapan + skorFisik + skorKeuangan + skorPartisipasi + skorTindakLanjut;

        return { 
            waktu: skorWaktu, 
            kelengkapan: skorKelengkapan, 
            fisik: skorFisik, 
            keuangan: skorKeuangan, 
            partisipasi: skorPartisipasi, 
            tindakLanjut: skorTindakLanjut, 
            total 
        };
    }

    // ============ TAB SWITCHING ============
    function switchTab(name, e) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        if (e) e.target.classList.add('active');
        document.getElementById('tab-' + name).classList.add('active');
        if (name === 'rekap') renderRekap();
    }

    // ============ STATS ============
    function updateStats(bulan) {
        const data = getLocalData();
        if (!bulan || !data[bulan]) {
            document.getElementById('avg-score-this-month').textContent = '‚Äî';
            document.getElementById('units-assessed').textContent = '0';
            document.getElementById('units-pending').textContent = '6';
            return;
        }
        const unitData = data[bulan];
        const vals = Object.values(unitData).map(u => u.total);
        const avg = vals.reduce((a, b) => a + b, 0) / vals.length;
        document.getElementById('avg-score-this-month').textContent = avg.toFixed(2);
        document.getElementById('units-assessed').textContent = vals.length;
        document.getElementById('units-pending').textContent = Math.max(0, 6 - vals.length);
    }

    // ============ TAB 1: INPUT ============
    document.getElementById('select-bulan-input').addEventListener('change', function() {
        renderInputTable(this.value);
        updateStats(this.value);
    });

    function renderInputTable(bulan) {
        const tbody = document.getElementById('input-tbody');
        if (!bulan) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:40px;color:#94a3b8;">Pilih bulan untuk melihat data</td></tr>';
            return;
        }
        const data = getLocalData();
        const monthData = data[bulan] || {};

        if (Object.keys(monthData).length === 0) {
            tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;padding:40px;color:#94a3b8;">Belum ada penilaian untuk ${bulan}. Klik tombol di unit untuk mulai.</td></tr>`;
        }

        tbody.innerHTML = UNITS.map(unit => {
            const u = monthData[unit];
            if (!u) return `<tr>
                <td style="font-weight:500;">${unit}</td>
                <td>${bulan}</td>
                <td colspan="7" style="color:#94a3b8;font-style:italic;">Belum dinilai</td>
                <td><button onclick="openInputModal('${unit}','${bulan}')" class="btn btn-sm btn-primary">+ Isi Nilai</button></td>
            </tr>`;
            
            const badgeClass = u.total >= 35 ? 'badge-green' : u.total >= 25 ? 'badge-yellow' : 'badge-red';
            return `<tr>
                <td style="font-weight:500;">${unit}</td>
                <td>${bulan}</td>
                <td>${u.waktu}</td>
                <td>${u.kelengkapan}</td>
                <td>${u.fisik}</td>
                <td>${u.keuangan}</td>
                <td>${u.partisipasi}</td>
                <td>${u.tindakLanjut}</td>
                <td><span class="badge ${badgeClass}">${u.total}</span></td>
                <td>
                    <button onclick="openInputModal('${unit}','${bulan}')" class="btn btn-sm">‚úèÔ∏è Edit</button>
                    <button onclick="deleteEntry('${unit}','${bulan}')" class="btn btn-sm" style="color:#ef4444;">üóëÔ∏è</button>
                </td>
            </tr>`;
        }).join('');
    }

    // ============ MODAL ============
    function openInputModal(unit, bulan) {
        if (!bulan) {
            bulan = document.getElementById('select-bulan-input').value;
            if (!bulan) { Toast.error('Pilih bulan terlebih dahulu'); return; }
        }
        
        const data = getLocalData();
        const u = (data[bulan] || {})[unit];
        
        document.getElementById('modal-bulan-label').textContent = `Unit: ${unit} | Bulan: ${bulan}`;
        document.getElementById('input-unit').value = unit;
        
        // Reset form
        document.querySelector('input[name="ketepatan-waktu"][value="tepat"]').checked = true;
        document.querySelector('input[name="kelengkapan-data"][value="lengkap"]').checked = true;
        document.querySelector('input[name="capaian-fisik"][value="sesuai"]').checked = true;
        document.querySelector('input[name="capaian-keuangan"][value="sesuai"]').checked = true;
        document.querySelector('input[name="partisipasi"][value="hadir"]').checked = true;
        document.querySelector('input[name="tindak-lanjut"][value="ya"]').checked = true;
        
        document.getElementById('keterlambatan').value = '0';
        document.getElementById('kualitas-data').value = '0';
        document.getElementById('deviasi-fisik').value = '0';
        document.getElementById('deviasi-keuangan').value = '0';
        document.getElementById('input-catatan').value = u ? u.catatan : '';
        
        document.getElementById('keterlambatan-group').style.display = 'none';
        document.getElementById('kualitas-data-group').style.display = 'none';
        document.getElementById('deviasi-fisik-group').style.display = 'none';
        document.getElementById('deviasi-keuangan-group').style.display = 'none';
        
        updateModalScore();
        openModal('inputModal');
    }

    function updateModalScore() {
        const waktuOption = document.querySelector('input[name="ketepatan-waktu"]:checked').value;
        const keterlambatan = document.getElementById('keterlambatan').value;
        
        const kelengkapanOption = document.querySelector('input[name="kelengkapan-data"]:checked').value;
        const kualitasData = document.getElementById('kualitas-data').value;
        
        const fisikOption = document.querySelector('input[name="capaian-fisik"]:checked').value;
        const deviasiFisik = document.getElementById('deviasi-fisik').value;
        
        const keuanganOption = document.querySelector('input[name="capaian-keuangan"]:checked').value;
        const deviasiKeuangan = document.getElementById('deviasi-keuangan').value;
        
        const partisipasi = document.querySelector('input[name="partisipasi"]:checked').value;
        const tindakLanjut = document.querySelector('input[name="tindak-lanjut"]:checked').value;
        
        const scores = calcMonevScores(waktuOption, kelengkapanOption, fisikOption, keuanganOption, partisipasi, tindakLanjut, keterlambatan, kualitasData, deviasiFisik, deviasiKeuangan);
        
        document.getElementById('score-waktu').textContent = scores.waktu;
        document.getElementById('score-kelengkapan').textContent = scores.kelengkapan;
        document.getElementById('score-fisik').textContent = scores.fisik;
        document.getElementById('score-keuangan').textContent = scores.keuangan;
        document.getElementById('score-partisipasi').textContent = scores.partisipasi;
        document.getElementById('score-tindak-lanjut').textContent = scores.tindakLanjut;
        document.getElementById('modal-total-nilai').textContent = scores.total;
    }

    // Event listeners for modal inputs
    document.addEventListener('DOMContentLoaded', function() {
        const keTepatanWaktuRadios = document.querySelectorAll('input[name="ketepatan-waktu"]');
        const kelengkapanDataRadios = document.querySelectorAll('input[name="kelengkapan-data"]');
        const capaianFisikRadios = document.querySelectorAll('input[name="capaian-fisik"]');
        const capaianKeuanganRadios = document.querySelectorAll('input[name="capaian-keuangan"]');
        const partisipasiRadios = document.querySelectorAll('input[name="partisipasi"]');
        const tindakLanjutRadios = document.querySelectorAll('input[name="tindak-lanjut"]');
        
        keTepatanWaktuRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                document.getElementById('keterlambatan-group').style.display = e.target.value === 'terlambat' ? 'block' : 'none';
                updateModalScore();
            });
        });
        
        kelengkapanDataRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                document.getElementById('kualitas-data-group').style.display = e.target.value === 'kurang' ? 'block' : 'none';
                updateModalScore();
            });
        });
        
        capaianFisikRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                document.getElementById('deviasi-fisik-group').style.display = e.target.value === 'deviasi' ? 'block' : 'none';
                updateModalScore();
            });
        });
        
        capaianKeuanganRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                document.getElementById('deviasi-keuangan-group').style.display = e.target.value === 'deviasi' ? 'block' : 'none';
                updateModalScore();
            });
        });
        
        partisipasiRadios.forEach(radio => radio.addEventListener('change', updateModalScore));
        tindakLanjutRadios.forEach(radio => radio.addEventListener('change', updateModalScore));
        
        document.getElementById('keterlambatan').addEventListener('change', updateModalScore);
        document.getElementById('kualitas-data').addEventListener('change', updateModalScore);
        document.getElementById('deviasi-fisik').addEventListener('change', updateModalScore);
        document.getElementById('deviasi-keuangan').addEventListener('change', updateModalScore);
    });

    async function submitInputNilai() {
        const bulan = document.getElementById('select-bulan-input').value;
        const unit = document.getElementById('input-unit').value;
        if (!unit || !bulan) { Toast.error('Data tidak lengkap'); return; }

        const waktuOption = document.querySelector('input[name="ketepatan-waktu"]:checked').value;
        const keterlambatan = document.getElementById('keterlambatan').value;
        
        const kelengkapanOption = document.querySelector('input[name="kelengkapan-data"]:checked').value;
        const kualitasData = document.getElementById('kualitas-data').value;
        
        const fisikOption = document.querySelector('input[name="capaian-fisik"]:checked').value;
        const deviasiFisik = document.getElementById('deviasi-fisik').value;
        
        const keuanganOption = document.querySelector('input[name="capaian-keuangan"]:checked').value;
        const deviasiKeuangan = document.getElementById('deviasi-keuangan').value;
        
        const partisipasi = document.querySelector('input[name="partisipasi"]:checked').value;
        const tindakLanjut = document.querySelector('input[name="tindak-lanjut"]:checked').value;
        const catatan = document.getElementById('input-catatan').value;

        const scores = calcMonevScores(waktuOption, kelengkapanOption, fisikOption, keuanganOption, partisipasi, tindakLanjut, keterlambatan, kualitasData, deviasiFisik, deviasiKeuangan);

        const submitBtn = document.getElementById('submit-input-btn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner"></span> Menyimpan...';

        // Save locally
        const data = getLocalData();
        if (!data[bulan]) data[bulan] = {};
        data[bulan][unit] = { ...scores, catatan };
        setLocalData(data);

        // Try API
        try {
            await callAPI({
                action: 'saveMonevData',
                bulan, unit, 
                waktu: scores.waktu,
                kelengkapan: scores.kelengkapan,
                fisik: scores.fisik,
                keuangan: scores.keuangan,
                partisipasi: scores.partisipasi,
                tindakLanjut: scores.tindakLanjut,
                total: scores.total,
                catatan,
                penilai: currentUser.name || 'Admin'
            });
        } catch (e) { /* API not configured yet, local save is fine */ }

        closeModal('inputModal');
        renderInputTable(bulan);
        updateStats(bulan);
        Toast.success(`Nilai ${unit} bulan ${bulan} berhasil disimpan!`);
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'üíæ Simpan Penilaian';
    }

    function deleteEntry(unit, bulan) {
        if (!confirm(`Hapus penilaian ${unit} bulan ${bulan}?`)) return;
        const data = getLocalData();
        if (data[bulan]) delete data[bulan][unit];
        setLocalData(data);
        renderInputTable(bulan);
        updateStats(bulan);
        Toast.success('Data berhasil dihapus');
    }

    // ============ TAB 2: REKAP ============
    let chartIndikator = null, chartTotal = null;

    function renderRekap() {
        const bulan = document.getElementById('select-bulan-rekap').value;
        const data = getLocalData();

        let targetData = {};
        if (bulan) {
            targetData[bulan] = data[bulan] || {};
        } else {
            // Use latest month with data
            const latestMonth = MONTHS.slice().reverse().find(m => data[m] && Object.keys(data[m]).length > 0);
            if (latestMonth) targetData[latestMonth] = data[latestMonth];
        }

        const currentBulan = bulan || Object.keys(targetData)[0] || '';
        const monthData = targetData[currentBulan] || {};

        // Build rekap rows
        const tbody = document.getElementById('rekap-tbody');
        const waktuVals = UNITS.map(u => monthData[u]?.waktu ?? 0);
        const kelengkapanVals = UNITS.map(u => monthData[u]?.kelengkapan ?? 0);
        const fisikVals = UNITS.map(u => monthData[u]?.fisik ?? 0);
        const keuanganVals = UNITS.map(u => monthData[u]?.keuangan ?? 0);
        const partisipasiVals = UNITS.map(u => monthData[u]?.partisipasi ?? 0);
        const tindakLanjutVals = UNITS.map(u => monthData[u]?.tindakLanjut ?? 0);
        const totalVals = UNITS.map(u => monthData[u]?.total ?? 0);

        tbody.innerHTML = `
            <tr>
                <td>1</td>
                <td style="font-weight:500;">Ketepatan Waktu</td>
                ${waktuVals.map(v => `<td class="${v < 5 ? 'rekap-bad' : 'rekap-good'}">${v}</td>`).join('')}
            </tr>
            <tr>
                <td>2</td>
                <td style="font-weight:500;">Kelengkapan Data</td>
                ${kelengkapanVals.map(v => `<td class="${v < 5 ? 'rekap-bad' : 'rekap-good'}">${v}</td>`).join('')}
            </tr>
            <tr>
                <td>3</td>
                <td style="font-weight:500;">Capaian Fisik</td>
                ${fisikVals.map(v => `<td class="${v < 10 ? 'rekap-bad' : 'rekap-good'}">${v}</td>`).join('')}
            </tr>
            <tr>
                <td>4</td>
                <td style="font-weight:500;">Capaian Keuangan</td>
                ${keuanganVals.map(v => `<td class="${v < 10 ? 'rekap-bad' : 'rekap-good'}">${v}</td>`).join('')}
            </tr>
            <tr>
                <td>5</td>
                <td style="font-weight:500;">Partisipasi PPTK</td>
                ${partisipasiVals.map(v => `<td class="${v < 5 ? 'rekap-bad' : 'rekap-good'}">${v}</td>`).join('')}
            </tr>
            <tr>
                <td>6</td>
                <td style="font-weight:500;">Tindak Lanjut</td>
                ${tindakLanjutVals.map(v => `<td class="${v < 5 ? 'rekap-bad' : 'rekap-good'}">${v}</td>`).join('')}
            </tr>
            <tr>
                <td></td>
                <td style="font-weight:700;">TOTAL NILAI</td>
                ${totalVals.map(v => `<td style="font-weight:700;color:${v >= 35 ? '#065f46' : v >= 25 ? '#92400e' : '#991b1b'};">${v}</td>`).join('')}
            </tr>
        `;

        // Render charts
        if (chartIndikator) chartIndikator.destroy();
        if (chartTotal) chartTotal.destroy();

        // Chart 1: Stacked bar showing all indicators per unit
        chartIndikator = new Chart(document.getElementById('chartIndikator').getContext('2d'), {
            type: 'bar',
            data: {
                labels: SHORT_UNITS,
                datasets: [
                    { label: 'Ketepatan Waktu', data: waktuVals, backgroundColor: '#3b82f6' },
                    { label: 'Kelengkapan', data: kelengkapanVals, backgroundColor: '#8b5cf6' },
                    { label: 'Fisik', data: fisikVals, backgroundColor: '#10b981' },
                    { label: 'Keuangan', data: keuanganVals, backgroundColor: '#f59e0b' },
                    { label: 'Partisipasi', data: partisipasiVals, backgroundColor: '#ec4899' },
                    { label: 'Tindak Lanjut', data: tindakLanjutVals, backgroundColor: '#06b6d4' }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: true, position: 'bottom' } },
                scales: {
                    x: { stacked: true },
                    y: { stacked: true, beginAtZero: true, max: 40 }
                }
            }
        });

        // Chart 2: Total score per unit
        chartTotal = new Chart(document.getElementById('chartTotal').getContext('2d'), {
            type: 'bar',
            data: {
                labels: SHORT_UNITS,
                datasets: [{
                    label: 'Total Nilai',
                    data: totalVals,
                    backgroundColor: totalVals.map(v => v >= 35 ? '#10b981' : v >= 25 ? '#f59e0b' : '#ef4444'),
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: ctx => `Nilai: ${ctx.parsed.y} / 40`
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: true, max: 40, ticks: { stepSize: 5 } }
                }
            }
        });
    }

    document.getElementById('select-bulan-rekap').addEventListener('change', renderRekap);

    // ============ API ============
    function callAPI(params) {
        return new Promise((resolve, reject) => {
            const cb = 'cb_' + Date.now();
            window[cb] = data => { cleanup(); resolve(data); };
            const qs = new URLSearchParams({ ...params, callback: cb }).toString();
            const s = document.createElement('script');
            s.src = `${APPS_SCRIPT_URL}?${qs}`;
            const t = setTimeout(() => { cleanup(); reject(new Error('timeout')); }, 12000);
            function cleanup() { clearTimeout(t); if (s.parentNode) s.parentNode.removeChild(s); delete window[cb]; }
            s.onerror = () => { cleanup(); reject(new Error('network')); };
            document.body.appendChild(s);
        });
    }

    // ============ MODAL HELPERS ============
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    window.onclick = e => { if (e.target.classList.contains('modal-overlay')) { e.target.style.display = 'none'; } };

    // ============ MOBILE MENU ============
    function toggleMobileMenu() { document.getElementById('sidebar').classList.toggle('mobile-open'); }

    // ============ AUTH ============
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    let currentUser = user;
    document.getElementById('admin-name').textContent = user.name || 'Administrator';
    document.getElementById('admin-email').textContent = user.email || 'admin@dinas.gov.id';
    function logout() { if (confirm("Keluar?")) { localStorage.clear(); location.href = 'login.html'; } }

    // ============ TOAST ============
    const Toast = {
        container: null,
        init() { if (!this.container) { this.container = document.createElement('div'); this.container.className = 'toast-container'; document.body.appendChild(this.container); } },
        show(msg, type = 'success') { this.init(); const el = document.createElement('div'); el.className = `toast ${type}`; el.innerHTML = `<span>${msg}</span>`; this.container.appendChild(el); setTimeout(() => el.remove(), 3000); },
        success(msg) { this.show(msg, 'success'); },
        error(msg) { this.show(msg, 'error'); }
    };

    // Auto-select current month
    const currentMonthIdx = new Date().getMonth();
    if (MONTHS[currentMonthIdx]) {
        document.getElementById('select-bulan-input').value = MONTHS[currentMonthIdx];
        renderInputTable(MONTHS[currentMonthIdx]);
        updateStats(MONTHS[currentMonthIdx]);
    }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengumpulan SPJ - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #1e293b;
            display: flex;
            min-height: 100vh;
        }

        /* ============ TOAST ============ */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { background: white; padding: 16px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 10px; min-width: 300px; animation: slideIn 0.3s ease-out; display: flex; align-items: center; gap: 12px; }
        .toast.success { border-left: 4px solid #10b981; }
        .toast.error { border-left: 4px solid #ef4444; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* ============ SIDEBAR ============ */
        .sidebar {
            width: 252px;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            left: 0; top: 0;
            z-index: 100;
        }

        .sidebar-header { padding: 20px 16px; border-bottom: 1px solid #e5e7eb; }
        .sidebar-header-content { display: flex; align-items: center; gap: 12px; }
        .sidebar-icon { width: 40px; height: 40px; background: #0f172a; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .sidebar-title { font-size: 16px; font-weight: 600; color: #1e293b; }
        .sidebar-subtitle { font-size: 12px; color: #64748b; }
        .sidebar-nav { flex: 1; padding: 16px 12px; display: flex; flex-direction: column; gap: 4px; }
        .sidebar-footer { padding: 16px 12px; border-top: 1px solid #e5e7eb; }

        .nav-item {
            display: flex; align-items: center; gap: 14px;
            padding: 12px 16px; border-radius: 10px; font-weight: 500; font-size: 15px;
            color: #0f172a; text-decoration: none; position: relative;
            transition: all 0.15s ease;
        }
        .nav-item:hover { background: #f8fafc; }
        .nav-item.active { background: #f1f5f9; }
        .nav-item.active::before {
            content: ''; position: absolute; left: 0; top: 8px; bottom: 8px;
            width: 4px; background: #0f172a; border-radius: 0 4px 4px 0;
        }

        .nav-icon { width: 20px; height: 20px; stroke: currentColor; fill: none; stroke-width: 1.8; }

        /* ============ MAIN ============ */
        .main-content { flex: 1; display: flex; flex-direction: column; margin-left: 252px; }
        .header { background: white; border-bottom: 1px solid #e5e7eb; padding: 24px 32px; }
        .header-title { font-size: 24px; font-weight: 600; color: #1e293b; margin-bottom: 4px; }
        .header-subtitle { font-size: 14px; color: #64748b; }
        .container { padding: 24px 32px; width: 100%; }

        /* ============ CARDS ============ */
        .card { background: white; border-radius: 8px; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 24px; }
        .card-header { padding: 20px 24px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
        .card-title { font-size: 18px; font-weight: 600; color: #1e293b; }
        .card-content { padding: 24px; }

        /* ============ STATS GRID ============ */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card { padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb; background: white; }
        .stat-label { font-size: 13px; color: #64748b; margin-bottom: 8px; }
        .stat-value { font-size: 32px; font-weight: 700; color: #1e293b; }
        .stat-subtitle { font-size: 12px; color: #64748b; margin-top: 4px; }

        /* ============ FORM ============ */
        .filter-container { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .select-input, .search-input { padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; font-family: 'Inter', sans-serif; }
        .select-input { width: 180px; }
        .search-input { width: 250px; }

        /* ============ TABLE ============ */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px 16px; font-size: 12px; font-weight: 600; color: #64748b; background: #f8fafc; border-bottom: 1px solid #e5e7eb; }
        td { padding: 14px 16px; font-size: 14px; color: #1e293b; border-bottom: 1px solid #f1f5f9; }
        tbody tr:hover { background: #fafbfc; }

        /* ============ BUTTONS ============ */
        .btn { padding: 8px 16px; border-radius: 6px; border: 1px solid #e5e7eb; font-size: 14px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; background: white; color: #1e293b; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s; text-decoration: none; }
        .btn:hover { background: #f8fafc; border-color: #cbd5e1; }
        .btn-primary { background: #0f172a; color: white; border-color: #0f172a; }
        .btn-primary:hover { background: #1e293b; }
        .btn-success { background: #10b981; color: white; border-color: #10b981; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: white; border-color: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        .btn-sm { padding: 5px 12px; font-size: 12px; }

        /* ============ BADGES ============ */
        .badge { padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 500; display: inline-block; }
        .badge-green { background: #d1fae5; color: #065f46; }
        .badge-yellow { background: #fef3c7; color: #92400e; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-red { background: #fee2e2; color: #991b1b; }

        /* ============ USER / LOGOUT ============ */
        .user-info { padding: 0 12px; margin-bottom: 16px; }
        .user-name { font-size: 14px; font-weight: 600; color: #1e293b; }
        .user-email { font-size: 12px; color: #64748b; }
        .logout-btn { width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; background: white; cursor: pointer; font-size: 14px; font-weight: 500; color: #1e293b; display: flex; align-items: center; justify-content: center; gap: 8px; font-family: 'Inter', sans-serif; }
        .logout-btn:hover { background: #f8fafc; }

        .mobile-menu-btn { display: none; position: fixed; top: 20px; left: 20px; z-index: 101; background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px 12px; cursor: pointer; }

        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; }

        .empty-state { text-align: center; padding: 60px 20px; color: #94a3b8; }
        .empty-state svg { width: 64px; height: 64px; margin: 0 auto 16px; opacity: 0.3; }
        .empty-state h3 { font-size: 16px; font-weight: 600; color: #64748b; margin-bottom: 8px; }
        .empty-state p { font-size: 14px; }

        .link-file { color: #3b82f6; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; }
        .link-file:hover { text-decoration: underline; }

        @media (max-width: 1023px) {
            .mobile-menu-btn { display: block; }
            .sidebar { transform: translateX(-100%); transition: transform 0.3s; }
            .sidebar.mobile-open { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞ Menu</button>

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-header-content">
                <div class="sidebar-icon">
                    <svg viewBox="0 0 24 24" style="width:20px;height:20px;stroke:white;fill:none;stroke-width:1.8">
                        <rect x="3" y="3" width="7" height="7" rx="1"/>
                        <rect x="14" y="3" width="7" height="7" rx="1"/>
                        <rect x="3" y="14" width="7" height="7" rx="1"/>
                        <rect x="14" y="14" width="7" height="7" rx="1"/>
                    </svg>
                </div>
                <div>
                    <div class="sidebar-title">Admin Panel</div>
                    <div class="sidebar-subtitle">Dinas Koperasi UKM</div>
                </div>
            </div>
        </div>

        <div class="sidebar-nav">
            <a href="admin-dashboard.html" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
                Dashboard
            </a>
            <a href="admin-requests.html" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M14 3H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><path d="M14 3v6h6"/></svg>
                Kendaraan Dinas
            </a>
            <a href="admin-voucher-bbm.html" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                Voucher BBM
            </a>
            <a href="admin-ruang-rapat.html" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                Ruang Rapat
            </a>
            <a href="admin-kearsipan.html" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                Kearsipan Internal
            </a>
            <a href="admin-spj-keuangan.html" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                Penilaian SPJ Keuangan
            </a>
            <a href="admin-spj-pengumpulan.html" class="nav-item active">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                Pengumpulan SPJ
            </a>
            <a href="admin-pengajuan-dana.html" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
                Pengajuan Dana
            </a>
        </div>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-name" id="admin-name">Administrator</div>
                <div class="user-email" id="admin-email">admin@dinas.gov.id</div>
            </div>
            <button onclick="logout()" class="logout-btn">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                Keluar
            </button>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div class="header">
            <h1 class="header-title">Pengumpulan Laporan SPJ</h1>
            <p class="header-subtitle">Monitoring penyampaian SPJ keuangan dari unit bidang per bulan</p>
        </div>

        <div class="container">
            <!-- STATS -->
            <div class="stats-grid">
                <div class="stat-card" style="border-left:4px solid #10b981;">
                    <div class="stat-label">Total Pengumpulan</div>
                    <div class="stat-value" id="total-pengumpulan">0</div>
                    <div class="stat-subtitle">Laporan SPJ</div>
                </div>
                <div class="stat-card" style="border-left:4px solid #3b82f6;">
                    <div class="stat-label">Bulan Ini</div>
                    <div class="stat-value" id="bulan-ini-count">0</div>
                    <div class="stat-subtitle" id="bulan-ini-label">Laporan</div>
                </div>
                <div class="stat-card" style="border-left:4px solid #f59e0b;">
                    <div class="stat-label">Pending</div>
                    <div class="stat-value" id="pending-count">0</div>
                    <div class="stat-subtitle">Menunggu Verifikasi</div>
                </div>
                <div class="stat-card" style="border-left:4px solid #64748b;">
                    <div class="stat-label">Total Nominal</div>
                    <div class="stat-value" id="total-nominal" style="font-size: 24px;">Rp 0</div>
                    <div class="stat-subtitle">Akumulasi SPJ</div>
                </div>
            </div>

            <!-- FILTER & TABLE -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Daftar Pengumpulan SPJ</h2>
                    <div class="filter-container">
                        <select class="select-input" id="filter-bulan" onchange="filterData()">
                            <option value="">Semua Bulan</option>
                            <option value="JANUARI">Januari</option>
                            <option value="FEBRUARI">Februari</option>
                            <option value="MARET">Maret</option>
                            <option value="APRIL">April</option>
                            <option value="MEI">Mei</option>
                            <option value="JUNI">Juni</option>
                            <option value="JULI">Juli</option>
                            <option value="AGUSTUS">Agustus</option>
                            <option value="SEPTEMBER">September</option>
                            <option value="OKTOBER">Oktober</option>
                            <option value="NOVEMBER">November</option>
                            <option value="DESEMBER">Desember</option>
                        </select>
                        <select class="select-input" id="filter-unit" onchange="filterData()">
                            <option value="">Semua Unit</option>
                            <option value="Sekretariat">Sekretariat</option>
                            <option value="Balai Layanan Usaha Terpadu KUMKM">BLUT KUMKM</option>
                            <option value="Bidang Kewirausahaan">Bid. Kewirausahaan</option>
                            <option value="Bidang Koperasi">Bid. Koperasi</option>
                            <option value="Bidang UKM">Bid. UKM</option>
                            <option value="Bidang Usaha Mikro">Bid. Usaha Mikro</option>
                        </select>
                        <select class="select-input" id="filter-status" onchange="filterData()">
                            <option value="">Semua Status</option>
                            <option value="PENDING">Pending</option>
                            <option value="APPROVED">Disetujui</option>
                            <option value="REJECTED">Ditolak</option>
                        </select>
                        <input type="text" class="search-input" id="search-nama" placeholder="üîç Cari nama pegawai..." oninput="filterData()">
                        <button onclick="loadData(true)" class="btn btn-primary" id="btn-refresh" title="Muat ulang data">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Timestamp</th>
                                <th>Nama</th>
                                <th>Unit</th>
                                <th>Bulan SPJ</th>
                                <th>Nominal SPJ</th>
                                <th>File Izin Terlambat</th>
                                <th>File SPJ</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="data-tbody">
                            <tr>
                                <td colspan="10" style="text-align:center;padding:40px;color:#94a3b8;">
                                    <div class="spinner" style="border-top-color:#94a3b8;"></div>
                                    <div style="margin-top:12px;">Memuat data...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxeUwUZXnG5kUGmSeN3P9L3HM86RJTNiNlytuCgJRofIgcXmh1Lm70n8uieKfEmFnHoDw/exec';
    const CACHE_KEY = 'spj_pengumpulan_cache';
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
    let allData = [];
    let filteredData = [];

    // ============ CACHE MANAGEMENT ============
    function getCachedData() {
        try {
            const cached = localStorage.getItem(CACHE_KEY);
            if (!cached) return null;
            
            const { data, timestamp } = JSON.parse(cached);
            const now = Date.now();
            
            if (now - timestamp < CACHE_DURATION) {
                console.log('Using cached data');
                return data;
            } else {
                console.log('Cache expired');
                localStorage.removeItem(CACHE_KEY);
                return null;
            }
        } catch (err) {
            console.error('Cache error:', err);
            return null;
        }
    }

    function setCachedData(data) {
        try {
            const cacheObj = {
                data: data,
                timestamp: Date.now()
            };
            localStorage.setItem(CACHE_KEY, JSON.stringify(cacheObj));
        } catch (err) {
            console.error('Failed to cache data:', err);
        }
    }

    function clearCache() {
        localStorage.removeItem(CACHE_KEY);
    }

    // ============ FORMAT TIMESTAMP ============
    function formatTimestamp(timestamp) {
        if (!timestamp) return '-';
        
        try {
            let date;
            if (typeof timestamp === 'string') {
                // Handle ISO format or custom format
                date = new Date(timestamp);
            } else if (timestamp instanceof Date) {
                date = timestamp;
            } else {
                return timestamp.toString();
            }
            
            if (isNaN(date.getTime())) return timestamp.toString();
            
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        } catch (err) {
            console.error('Format timestamp error:', err);
            return timestamp.toString();
        }
    }

    // ============ LOAD DATA ============
    async function loadData(forceRefresh = false) {
        // Try cache first
        if (!forceRefresh) {
            const cachedData = getCachedData();
            if (cachedData) {
                allData = cachedData;
                filteredData = [...allData];
                renderTable();
                updateStats();
                return;
            }
        }

        // Show loading
        const tbody = document.getElementById('data-tbody');
        tbody.innerHTML = `
            <tr>
                <td colspan="10" style="text-align:center;padding:40px;color:#94a3b8;">
                    <div class="spinner" style="border-top-color:#94a3b8;"></div>
                    <div style="margin-top:12px;">Memuat data...</div>
                </td>
            </tr>
        `;

        try {
            const result = await callAPI({ action: 'getPenyampaianSPJ' });
            if (result.success) {
                allData = result.data || [];
                filteredData = [...allData];
                
                // Cache the data
                setCachedData(allData);
                
                renderTable();
                updateStats();
            } else {
                showEmptyState('Gagal memuat data: ' + (result.message || 'Unknown error'));
            }
        } catch (err) {
            console.error('Load error:', err);
            showEmptyState('Gagal memuat data. Periksa koneksi internet Anda.');
        }
    }

    // ============ FILTER DATA ============
    function filterData() {
        const bulan = document.getElementById('filter-bulan').value.toUpperCase();
        const unit = document.getElementById('filter-unit').value;
        const status = document.getElementById('filter-status').value.toUpperCase();
        const search = document.getElementById('search-nama').value.toLowerCase();

        filteredData = allData.filter(item => {
            const matchBulan = !bulan || item.bulanSPJ?.toUpperCase() === bulan;
            const matchUnit = !unit || item.unit === unit;
            const matchStatus = !status || item.status?.toUpperCase() === status;
            const matchSearch = !search || item.nama?.toLowerCase().includes(search);
            return matchBulan && matchUnit && matchStatus && matchSearch;
        });

        renderTable();
        updateStats();
    }

    // ============ RENDER TABLE ============
    function renderTable() {
        const tbody = document.getElementById('data-tbody');
        
        if (filteredData.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="10">
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <h3>Tidak ada data</h3>
                            <p>Belum ada pengumpulan SPJ atau filter tidak menemukan hasil</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        const fmt = n => new Intl.NumberFormat('id-ID').format(n);
        tbody.innerHTML = filteredData.map((item, idx) => {
            const statusClass = item.status === 'APPROVED' ? 'badge-green' : item.status === 'REJECTED' ? 'badge-red' : 'badge-yellow';
            const statusText = item.status === 'APPROVED' ? 'Disetujui' : item.status === 'REJECTED' ? 'Ditolak' : 'Pending';
            
            return `
                <tr>
                    <td>${idx + 1}</td>
                    <td>${formatTimestamp(item.timestamp)}</td>
                    <td style="font-weight:500;">${item.nama || '-'}</td>
                    <td>${item.unit || '-'}</td>
                    <td>${item.bulanSPJ || '-'}</td>
                    <td>Rp ${item.nominalSPJMasuk ? fmt(item.nominalSPJMasuk) : '0'}</td>
                    <td>${item.linkFileIzinKeterlambatan ? `<a href="${item.linkFileIzinKeterlambatan}" target="_blank" class="link-file">üìÑ Lihat File</a>` : '-'}</td>
                    <td>${item.linkFileSPJ ? `<a href="${item.linkFileSPJ}" target="_blank" class="link-file">üìÑ Lihat SPJ</a>` : '-'}</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>
                        ${item.status === 'PENDING' ? `
                            <button onclick="approveItem('${item.id}')" class="btn btn-sm btn-success" id="btn-approve-${item.id}">‚úì Setujui</button>
                            <button onclick="rejectItem('${item.id}')" class="btn btn-sm btn-danger" id="btn-reject-${item.id}">‚úó Tolak</button>
                        ` : `
                            <button onclick="viewDetail('${item.id}')" class="btn btn-sm">üëÅÔ∏è Detail</button>
                        `}
                    </td>
                </tr>
            `;
        }).join('');
    }

    // ============ UPDATE STATS ============
    function updateStats() {
        const currentMonth = new Date().toLocaleString('id-ID', { month: 'long' }).toUpperCase();
        const bulanIniData = allData.filter(item => item.bulanSPJ?.toUpperCase() === currentMonth);
        const pendingData = allData.filter(item => item.status === 'PENDING');
        const totalNominal = filteredData.reduce((sum, item) => sum + (parseFloat(item.nominalSPJMasuk) || 0), 0);

        document.getElementById('total-pengumpulan').textContent = allData.length;
        document.getElementById('bulan-ini-count').textContent = bulanIniData.length;
        document.getElementById('pending-count').textContent = pendingData.length;
        document.getElementById('total-nominal').textContent = 'Rp ' + new Intl.NumberFormat('id-ID').format(totalNominal);
        document.getElementById('bulan-ini-label').textContent = `${currentMonth} 2026`;
    }

    // ============ ACTIONS ============
    async function approveItem(id) {
        if (!confirm('Setujui pengumpulan SPJ ini?')) return;
        
        const approveBtn = document.getElementById(`btn-approve-${id}`);
        const rejectBtn = document.getElementById(`btn-reject-${id}`);
        
        if (!approveBtn || !rejectBtn) return;
        
        // Disable buttons and show loading
        approveBtn.disabled = true;
        rejectBtn.disabled = true;
        approveBtn.innerHTML = '<span class="spinner"></span> Memproses...';
        
        try {
            const result = await callAPI({ action: 'updateStatusSPJ', id: id, status: 'APPROVED' });
            if (result.success) {
                Toast.success('SPJ berhasil disetujui');
                clearCache(); // Clear cache to force refresh
                await loadData(true); // Force refresh from server
            } else {
                Toast.error(result.message || 'Gagal menyetujui SPJ');
                // Re-enable buttons on error
                approveBtn.disabled = false;
                rejectBtn.disabled = false;
                approveBtn.innerHTML = '‚úì Setujui';
            }
        } catch (err) {
            Toast.error('Terjadi kesalahan saat menyetujui SPJ');
            // Re-enable buttons on error
            approveBtn.disabled = false;
            rejectBtn.disabled = false;
            approveBtn.innerHTML = '‚úì Setujui';
        }
    }

    async function rejectItem(id) {
        if (!confirm('Tolak pengumpulan SPJ ini?')) return;
        
        const approveBtn = document.getElementById(`btn-approve-${id}`);
        const rejectBtn = document.getElementById(`btn-reject-${id}`);
        
        if (!approveBtn || !rejectBtn) return;
        
        // Disable buttons and show loading
        approveBtn.disabled = true;
        rejectBtn.disabled = true;
        rejectBtn.innerHTML = '<span class="spinner"></span> Memproses...';
        
        try {
            const result = await callAPI({ action: 'updateStatusSPJ', id: id, status: 'REJECTED' });
            if (result.success) {
                Toast.success('SPJ berhasil ditolak');
                clearCache(); // Clear cache to force refresh
                await loadData(true); // Force refresh from server
            } else {
                Toast.error(result.message || 'Gagal menolak SPJ');
                // Re-enable buttons on error
                approveBtn.disabled = false;
                rejectBtn.disabled = false;
                rejectBtn.innerHTML = '‚úó Tolak';
            }
        } catch (err) {
            Toast.error('Terjadi kesalahan saat menolak SPJ');
            // Re-enable buttons on error
            approveBtn.disabled = false;
            rejectBtn.disabled = false;
            rejectBtn.innerHTML = '‚úó Tolak';
        }
    }

    function viewDetail(id) {
        const item = allData.find(d => d.id === id);
        if (item) {
            alert(`Detail SPJ:\n\nNama: ${item.nama}\nUnit: ${item.unit}\nBulan: ${item.bulanSPJ}\nNominal: Rp ${new Intl.NumberFormat('id-ID').format(item.nominalSPJMasuk || 0)}\nStatus: ${item.status}`);
        }
    }

    function showEmptyState(message) {
        const tbody = document.getElementById('data-tbody');
        tbody.innerHTML = `
            <tr>
                <td colspan="10">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <h3>Tidak dapat memuat data</h3>
                        <p>${message}</p>
                    </div>
                </td>
            </tr>
        `;
    }

    // ============ API CALL ============
    function callAPI(params) {
        return new Promise((resolve, reject) => {
            const cb = 'cb_' + Date.now();
            window[cb] = data => { cleanup(); resolve(data); };
            const qs = new URLSearchParams({ ...params, callback: cb }).toString();
            const s = document.createElement('script');
            s.src = `${APPS_SCRIPT_URL}?${qs}`;
            const t = setTimeout(() => { cleanup(); reject(new Error('timeout')); }, 12000);
            function cleanup() { clearTimeout(t); if (s.parentNode) s.parentNode.removeChild(s); delete window[cb]; }
            s.onerror = () => { cleanup(); reject(new Error('network')); };
            document.body.appendChild(s);
        });
    }

    // ============ MOBILE MENU ============
    function toggleMobileMenu() { document.getElementById('sidebar').classList.toggle('mobile-open'); }

    // ============ AUTH ============
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    document.getElementById('admin-name').textContent = user.name || 'Administrator';
    document.getElementById('admin-email').textContent = user.email || 'admin@dinas.gov.id';
    function logout() { if (confirm("Keluar?")) { localStorage.clear(); location.href = 'login.html'; } }

    // ============ TOAST ============
    const Toast = {
        container: null,
        init() { if (!this.container) { this.container = document.createElement('div'); this.container.className = 'toast-container'; document.body.appendChild(this.container); } },
        show(msg, type = 'success') { this.init(); const el = document.createElement('div'); el.className = `toast ${type}`; el.innerHTML = `<span>${msg}</span>`; this.container.appendChild(el); setTimeout(() => el.remove(), 3000); },
        success(msg) { this.show(msg, 'success'); },
        error(msg) { this.show(msg, 'error'); }
    };

    // ============ INIT ============
    loadData();

    // Auto-select current month
    const currentMonthName = new Date().toLocaleString('id-ID', { month: 'long' }).toUpperCase();
    document.getElementById('filter-bulan').value = currentMonthName;
    </script>
</body>
</html>